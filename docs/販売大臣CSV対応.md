# 販売大臣CSVフォーマット対応ガイド

在庫管理システムにおける販売大臣AXからエクスポートされたCSVファイルの取り込み対応について説明します。

## 📋 対応概要

販売大臣AXから出力される171列の日本語ヘッダー付きCSVファイルに対応しました。

### 対応フォーマット

- **売上伝票CSV**: 171列、日本語ヘッダー
- **仕入伝票CSV**: 171列、日本語ヘッダー  
- **受注伝票CSV** (在庫調整): 171列、日本語ヘッダー

### 主な改善点

1. **日本語ヘッダー対応**: `[Name("列名")]`属性での列名指定
2. **インデックス指定**: `[Index(番号)]`属性での位置指定
3. **エラー耐性**: 不正データがあっても処理を継続
4. **日付解析**: YYYYMMDD形式の日付に対応
5. **伝票種別変換**: 数値コードから文字列への自動変換

## 🔧 新規作成ファイル

### CSVマッピングクラス

| ファイル | 説明 |
|---------|------|
| `SalesVoucherDaijinCsv.cs` | 売上伝票の販売大臣フォーマット |
| `PurchaseVoucherDaijinCsv.cs` | 仕入伝票の販売大臣フォーマット |
| `InventoryAdjustmentDaijinCsv.cs` | 在庫調整の販売大臣フォーマット |

### 主要な列マッピング

```csharp
[Name("伝票番号(自動採番)")]
[Index(0)]
public string VoucherNumber { get; set; }

[Name("伝票日付(西暦4桁YYYYMMDD)")]
[Index(1)]  
public string VoucherDate { get; set; }

[Name("ジョブデート")]
[Index(47)]  // 48列目
public string JobDate { get; set; }

[Name("商品コード")]
[Index(88)]  // 89列目
public string ProductCode { get; set; }

[Name("数量")]
[Index(93)]  // 94列目
public decimal Quantity { get; set; }
```

## 📝 取り込み手順

### 1. CSVファイルの準備

販売大臣AXから以下の形式でエクスポート：
- ヘッダー行あり
- UTF-8エンコーディング
- 171列のフルフォーマット

### 2. 取り込み実行

```bash
# 売上伝票
dotnet run import-sales /path/to/sales.csv 2025-06-19

# 仕入伝票  
dotnet run import-purchase /path/to/purchase.csv 2025-06-19

# 在庫調整
dotnet run import-adjustment /path/to/adjustment.csv 2025-06-19
```

### 3. 取り込み確認

```bash
# データベース接続テスト
dotnet run test-connection

# アンマッチリスト確認
dotnet run unmatch-list 2025-06-19
```

## 🔄 データ変換ルール

### 伝票種別変換

**売上伝票**:
- `51` → `掛売上` (Credit)
- `52` → `現金売上` (Cash)

**仕入伝票**:
- `61` → `掛仕入` (Credit)  
- `62` → `現金仕入` (Cash)

**在庫調整**:
- `71` → `受注`
- `72` → `注文`

### 明細種別変換

- `1` → `売上/仕入` (Product)
- `2` → `返品` (Return)
- `4` → `値引` (Discount)

### 日付変換

```csharp
// YYYYMMDD形式 → DateTime
"20250619" → DateTime(2025, 6, 19)
```

### 除外ルール

**在庫調整での除外対象**:
- カテゴリ `2`: 経費
- カテゴリ `5`: 加工

## ⚠️ 注意事項

### 商品分類の取得

販売大臣CSVには商品分類が含まれない場合があります。この場合：

1. デフォルト値（空文字）を設定
2. 後から商品マスタから取得して補完

### エラーハンドリング

- 不正なレコードがあっても処理を継続
- エラー詳細はログに出力
- 部分的な取り込み成功も許可

### パフォーマンス

- 1000件単位のバッチ処理
- 大量データでもメモリ効率を保持
- 並列処理による高速化

## 🧪 テスト方法

### 1. 単体テスト用CSVの作成

```csv
伝票番号(自動採番),伝票日付(西暦4桁YYYYMMDD),...,ジョブデート,...,商品コード,...,数量,単価,金額
TEST001,20250619,...,20250619,...,00001,...,100.00,1000.00,100000.00
```

### 2. 取り込みテスト

```bash
# テスト用CSVで取り込み
dotnet run import-sales test_sales.csv 2025-06-19

# 結果確認
dotnet run test-connection
```

### 3. アンマッチ確認

```bash
# アンマッチリスト生成
dotnet run unmatch-list 2025-06-19

# PDF出力確認
ls *.pdf
```

## 🔍 トラブルシューティング

### 列数不一致エラー

```
対策: 171列すべてが含まれているか確認
→ 不足列があっても処理は継続されます
```

### 文字化けエラー

```
対策: UTF-8エンコーディングで保存
→ CSV出力時のエンコーディング設定を確認
```

### 日付解析エラー

```
対策: YYYYMMDD形式になっているか確認
→ "20250619" のような8桁数値形式
```

### 大量データでのメモリエラー

```
対策: バッチサイズを調整
→ デフォルト1000件単位で処理
```

## 📊 対応状況

| 機能 | 状況 | 備考 |
|------|------|------|
| 売上伝票取り込み | ✅ 完了 | 171列対応 |
| 仕入伝票取り込み | ✅ 完了 | 171列対応 |
| 在庫調整取り込み | ✅ 完了 | 171列対応 |
| 日本語ヘッダー | ✅ 完了 | Name属性対応 |
| エラー耐性 | ✅ 完了 | 部分取り込み可能 |
| バッチ処理 | ✅ 完了 | 1000件単位 |
| ログ出力 | ✅ 完了 | 詳細ログ対応 |

この対応により、販売大臣AXからの実際のCSVデータを正常に取り込むことができるようになりました。