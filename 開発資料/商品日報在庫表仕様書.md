# 在庫管理システム帳票仕様書

## 1. 商品日報
（詳細な実装・処理手順は「SE2_仕様_商品日報_プロセス2-5.md」を参照）

### 1.1 概要
- **目的**: 日次・月次の売上と粗利益を商品別に集計・分析
- **データソース**: CP在庫M（在庫マスタ）
- **出力形式**: A4横向き

### 1.2 レイアウト構造

```
※　202Y年99月99日　商　品　日　報　※

[日計セクション]                                    [月計セクション]
商品名 | 売上数量 | 売上金額 | ... | １粗利益 | １粗利率 | ２粗利益 | ２粗利率 | 売上金額 | １粗利益 | １粗利率 | ２粗利益 | ２粗利率
```

### 1.3 項目定義

#### 日計項目（当日分）
| 番号 | 項目名 | データ元 | フォーマット | 説明 |
|------|--------|----------|--------------|------|
| ① | 売上数量 | 日計売上数量 | `ZZ,ZZ9.99-` | 当日の売上数量 |
| ② | 売上金額 | 日計売上金額＋日計売上返品金額 | `ZZ,ZZZ,ZZ9-` | 当日の売上金額（返品含む） |
| ③ | 仕入値引 | 日計仕入値引金額 | `ZZ,ZZZ,ZZ9-` | 当日の仕入値引額 |
| ④ | 在庫調整 | 日計在庫調整金額 | `ZZ,ZZZ,ZZ9-` | 当日の在庫調整額 |
| ⑤ | 加工費 | 日計加工金額 | `Z,ZZZ,ZZ9-` | 当日の加工費 |
| ⑥ | 振替 | 日計振替金額 | `Z,ZZZ,ZZ9-` | 当日の振替金額 |
| ⑦ | 奨励金 | 日計奨励金 | `Z,ZZZ,ZZ9-` | 当日の奨励金 |
| ⑧ | １粗利益 | 日計粗利益 | `ZZ,ZZZ,ZZ9-` | 第1段階粗利益 |
| ⑨ | １粗利率 | 計算値 | `ZZ9.99-%` | ⑧÷②×100（小数第3位四捨五入） |
| ⑩ | ２粗利益 | 日計粗利益－日計歩引額 | `ZZ,ZZZ,ZZ9-` | 第2段階粗利益（歩引後） |
| ⑪ | ２粗利率 | 計算値 | `ZZ9.99-%` | ⑩÷②×100（小数第3位四捨五入） |

#### 月計項目（当月累計）
| 番号 | 項目名 | データ元 | フォーマット | 説明 |
|------|--------|----------|--------------|------|
| ⑫ | 売上金額 | 日計売上金額＋日計売上返品金額＋月計売上金額＋月計売上返品金額 | `ZZZ,ZZZ,ZZ9-` | 月累計売上金額 |
| ⑬ | １粗利益 | 日計粗利益＋月計粗利益 | `ZZ,ZZZ,ZZ9-` | 月累計第1段階粗利益 |
| ⑭ | １粗利率 | 計算値 | `ZZ9.99-%` | ⑬÷⑫×100（小数第3位四捨五入） |
| ⑮ | ２粗利益 | 日計粗利益＋月計粗利益－日計歩引額－月計歩引額 | `ZZ,ZZZ,ZZ9▲-` | 月累計第2段階粗利益 |
| ⑯ | ２粗利率 | 計算値 | `ZZ9.99-%` | ⑮÷⑫×100（小数第3位四捨五入） |

### 1.4 処理仕様

#### ソート順序
1. 商品分類1（担当者コード）
2. 商品コード

#### 集計ルール
1. CP在庫Mを上記順序でソート
2. 各商品の明細行を出力
   - **オール0の明細は印字しない**
3. 商品分類1が変わったら「＊　大分類計　＊」を印字
   - 明細がない大分類計は印字しない
4. 最終行に「※　合　　計　※」を印字

#### 粗利益計算式
```
第1段階粗利益 = (売上単価 - 在庫単価) × 数量
第2段階粗利益 = 第1段階粗利益 - 歩引額
```

### 1.5 表示フォーマット記号
- `Z`: ゼロサプレス（先頭の0を空白に）
- `9`: 数字表示
- `,`: 3桁区切りカンマ
- `.`: 小数点
- `-`: マイナス記号（負の値の場合のみ）
- `▲`: 負の値を示す三角印
- `%`: パーセント記号

---

## 2. 在庫表

### 2.1 概要
- **目的**: 現在の在庫状況を担当者別・商品別に表示
- **データソース**: CP在庫M
- **出力形式**: A4縦向き

### 2.2 レイアウト構造

```
※　202Y年99月99日　在　庫　表　※

担当者コード: XX

商品名 | 荷印 | 等級 | 階級 | 在庫数量 | 在庫単価 | 在庫金額 | 最終入荷日 | ﾏｰｸ
```

### 2.3 項目定義

| 項目名 | データ元 | フォーマット | 説明 |
|---------|----------|--------------|------|
| 商品名 | 商品マスタ | 文字列 | 商品名称 |
| 荷印 | 荷印マスタ | 文字列 | 荷印名称 |
| 等級 | 等級マスタ | 文字列 | 等級名称 |
| 階級 | 階級マスタ | 文字列 | 階級名称 |
| 在庫数量 | 当日在庫数量 | `ZZ,ZZ9.99-` | 現在の在庫数量 |
| 在庫単価 | 当日在庫単価 | `ZZZ,ZZ9` | 現在の在庫単価 |
| 在庫金額 | 当日在庫金額 | `ZZ,ZZZ,ZZ9-` | 在庫数量×在庫単価 |
| 最終入荷日 | 最終入荷日 | `(YY-MM-DD)` | 最後に入荷した日付 |
| ﾏｰｸ | 計算値 | `!` `!!` `!!!` | 滞留警告マーク |

### 2.4 処理仕様

#### ソート順序
1. 担当者コード（商品分類1）- **改ページ**
2. 商品コード
3. 荷印コード
4. 荷印名（手入力）
5. 等級コード
6. 階級コード

#### 集計ルール
1. **前日在庫数が0の行は印字しない**
2. **当日在庫数量および当日在庫金額が0の明細は印字しない**
3. 担当者コードが変わったら改ページ
4. 商品コードが変わったら「＊　小　　計　＊」を印字
   - 明細がない小計は印字しない
5. 最終行に「※　合　　計　※」を印字

#### 滞留警告マーク仕様
最終入荷日からの経過日数により表示：
- 11日以上20日経過: `!`
- 21日以上30日経過: `!!`
- 31日以上経過: `!!!`

---

## 3. 共通仕様

### 3.1 除外データルール
以下のデータは処理によって扱いが異なる：

#### アンマッチ・商品勘定で除外
- 荷印名の先頭4文字が「EXIT」「exit」
- 荷印コードが「9900」「9910」「1353」

#### 商品日報・在庫表では使用
上記の除外データも含めて処理

### 3.2 特殊処理ルール
荷印名による商品分類1の自動設定：
- 荷印名先頭「9aaa」→ 商品分類1='8'
- 荷印名先頭「1aaa」→ 商品分類1='6'
- 荷印名先頭「0999」→ 商品分類1='6'

### 3.3 CP在庫M作成ルール
1. 各処理（アンマッチ、商品勘定、商品日報等）で**毎回新規に作成**
2. 当日エリアクリア → 当日発生フラグ='9'
3. データ集計 → 当日発生フラグ='0'
4. 在庫計算・粗利計算を実行

### 3.4 データ量の目安
- 売上伝票: 500-1,200件/日
- 仕入伝票: 200-400件/日
- 在庫マスタ: 年間約10,000件

---

## 4. マスタファイル構造

### 4.1 商品分類マスタ（CSV）
| カラム名 | 型 | 説明 |
|----------|-----|------|
| コード | String | 商品分類コード |
| 名称 | String | 商品分類名称 |
| 検索カナ | String | 検索用カナ |

### 4.2 在庫マスタキー構造（5項目複合キー）
```csharp
public class InventoryKey
{
    public string ProductCode { get; set; }      // 商品コード
    public string GradeCode { get; set; }        // 等級コード  
    public string ClassCode { get; set; }        // 階級コード
    public string ShippingMarkCode { get; set; } // 荷印コード
    public string ShippingMarkName { get; set; } // 荷印名
}
```

---

## 5. 実装時の注意事項

### 5.1 パフォーマンス
- バッチ処理は1000件単位で実行
- 大量データは一括読み込みしない
- 帳票生成は可能な限り並列化

### 5.2 エラーハンドリング
- 0除算対策を必ず実装（粗利率計算時）
- データセットID管理による誤操作防止
- 日次終了処理は最終商品日報と同じデータセットのみ処理可能

### 5.3 日付管理
- **汎用日付2（ジョブデート）**を使用
- 伝票日付ではなく、実際の入力日で処理

### 5.4 ファイル構成
```
D:\InventoryImport\
└── User01\（部門別）
    ├── Import\     # CSV取込先
    ├── Processed\  # 処理済み
    └── Error\      # エラー
```
