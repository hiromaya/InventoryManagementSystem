# アンマッチリスト帳票レイアウト仕様

## 1. 帳票の基本情報

### ヘッダー情報
```
作成日：202Y年99月99日99時9分99秒                    ZZZ9 頁
※　202Y年99月99日　アンマッチリスト　※
```

### 列構成
| 列名 | 形式 | 説明 |
|------|------|------|
| 区分 | 文字 | 伝票種別（掛売上、現金売上、掛仕入、現金仕入、在庫調整、振替、加工費） |
| ｺｰﾄﾞ | 99999 | 取引先コード（5桁） |
| 取引先名 | 文字 | 得意先名または仕入先名（在庫調整は空白） |
| ｺｰﾄﾞ | 99999 | 商品コード（5桁） |
| 商　品　名 | 文字 | 商品名 |
| ｺｰﾄﾞ | 9999 | 荷印コード（4桁） |
| 荷　印 | 文字 | 荷印名 |
| 手入力 | 文字 | 荷印名（手入力） |
| ｺｰﾄﾞ | 999 | 等級コード（3桁） |
| 等　級 | 文字 | 等級名 |
| ｺｰﾄﾞ | 999 | 階級コード（3桁） |
| 階　級 | 文字 | 階級名 |
| 数　量 | ZZ,ZZ9.99- | 数量（小数2桁、マイナス表示） |
| 単　価 | ZZZ,ZZ9 | 単価 |
| 金　額 | ZZ,ZZZ,ZZ9- | 金額（マイナス表示） |
| 伝票番号 | 999999 | 伝票番号（6桁） |
| ｱﾗｰﾄ | 文字 | エラー種別 |

## 2. アンマッチデータがある場合

### 表示される区分の種類
1. **掛売上** - 得意先名あり
2. **現金売上** - 得意先名あり
3. **掛仕入** - 仕入先名あり
4. **現金仕入** - 仕入先名あり
5. **在庫調整** - 取引先名なし（空白）
6. **振替** - 取引先名なし（空白）
7. **加工費** - 取引先名なし（空白）

### アラート表示
- **在庫0**: 在庫切れエラー
- **該当無**: マスタに該当データなし

### フッター
```
アンマッチ件数＝0009
```
※4桁で件数表示

## 3. アンマッチデータがない場合

### 簡潔な表示
```
作成日：202Y年99月99日99時9分99秒
※　202Y年99月99日　アンマッチリスト　※


アンマッチ件数＝0000
```

## 4. ソート順（重要）

明細データは以下の順序でソート：
1. **商品分類1**（担当者）
2. **商品コード**
3. **荷印コード**
4. **荷印名**（手入力）
5. **等級コード**
6. **階級コード**

## 5. 処理ロジック

### 実装手順
1. 売上伝票、仕入伝票、在庫調整を1つのテーブルに統合
2. CP在庫Mのキーと同じ順序で並べ替え
3. 当日在庫を計算したCP在庫Mを参照
4. アンマッチ条件に該当する行を抽出して印刷

### アンマッチ判定条件

#### 売上伝票
1. **在庫0**: CP在庫Mの「前日在庫数量≧0」かつ「当日在庫数量＝0」
2. **該当無**: CP在庫Mにキーが存在しない

#### 仕入伝票
1. **在庫0**: CP在庫Mの「当日在庫数量＝0」
2. **該当無**: CP在庫Mにキーが存在しない

#### 在庫調整
1. **在庫0**: CP在庫Mの「前日在庫数量＝0」かつ「在庫調整の数量＜0」

### 共通仕様
- 数量が0の行は処理対象外
- 在庫調整で単位コードが「02=経費」「05=加工」の行は処理対象外

## 6. 数値フォーマット仕様

### 数量表示
- フォーマット: `ZZ,ZZ9.99-`
- 例: `12,345.67-`（マイナス値）
- 整数部: 最大5桁、3桁区切り
- 小数部: 2桁固定
- マイナス: 末尾に"-"表示

### 単価表示
- フォーマット: `ZZZ,ZZ9`
- 例: `123,456`
- 最大6桁、3桁区切り

### 金額表示
- フォーマット: `ZZ,ZZZ,ZZ9-`
- 例: `12,345,678-`（マイナス値）
- 最大8桁、3桁区切り
- マイナス: 末尾に"-"表示

## 7. 実装上の注意点

1. **文字幅の考慮**
   - 日本語は全角文字として扱う
   - 取引先名、商品名等は固定幅で表示
   - はみ出す場合は適切に省略

2. **PDF出力**
   - A3横向きで出力
   - 処理終了後、自動的にPDFを表示
   - フォントサイズは可読性を考慮

3. **性能考慮**
   - 大量データ時のページング処理
   - ソート処理の最適化
   - メモリ効率を考慮したバッチ処理

## 8. エラーハンドリング

- CP在庫Mが作成できない場合の対処
- 伝票データが存在しない場合の対処
- PDF生成エラー時の対処