<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在庫管理システム - 新しい運用手順ガイド（初期導入から日次処理まで）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .data-info {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .phase {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .phase:hover {
            transform: translateY(-5px);
        }
        
        .phase-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .phase-number {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 20px;
        }
        
        .phase-title {
            font-size: 1.5rem;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .command-block {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            position: relative;
            overflow-x: auto;
        }
        
        .command-block::before {
            content: 'PowerShell';
            position: absolute;
            top: 5px;
            right: 10px;
            background: #007acc;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .command-line {
            margin: 8px 0;
            display: block;
        }
        
        .comment {
            color: #6a9955;
            font-style: italic;
        }
        
        .step {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #2ecc71;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .warning {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .info {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .success {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #2ecc71;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .verification {
            background: rgba(142, 68, 173, 0.1);
            border-left: 4px solid #8e44ad;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 5px;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            border: 3px solid white;
        }
        
        .date-range {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }
        
        .troubleshooting {
            background: rgba(241, 196, 15, 0.1);
            border: 2px solid #f1c40f;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }
        
        .button {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .phase {
                padding: 20px;
            }
            
            .command-block {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📋 在庫管理システム</h1>
            <p>新しい運用手順ガイド（初期導入から日次処理まで）</p>
            <p><strong>最終更新:</strong> 2025年7月11日 - トランザクション管理実装 | <strong>対象:</strong> 開発・運用</p>
        </div>

        <div class="phase" style="background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%); color: white;">
            <div class="phase-header">
                <div class="phase-number" style="background: white; color: #3498db;">🎯</div>
                <div class="phase-title" style="color: white;">Phase 1: 初期導入（システム開始時のみ）</div>
            </div>
            
            <div class="step" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h4 style="color: white;">Step 1: データベース準備</h4>
                <div class="command-block">
<span class="comment"># データベース初期化（必要な場合のみ）</span>
<span class="command-line">dotnet run init-database --force</span>

<span class="comment"># 接続確認</span>
<span class="command-line">dotnet run test-connection</span>
                </div>
            </div>

            <div class="step" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h4 style="color: white;">Step 2: 前月末在庫の登録（最重要）</h4>
                <div class="command-block">
<span class="comment"># 前月末在庫.csvをD:\InventoryImport\DeptA\Import\に配置</span>

<span class="comment"># 前月末在庫を登録（DataSetId付与）</span>
<span class="command-line">dotnet run init-inventory DeptA</span>

<span class="comment"># 登録確認</span>
<span class="command-line">dotnet run check-inventory-status</span>
                </div>
                <div class="success" style="margin-top: 15px;">
                    <strong>✅ 重要ポイント:</strong>
                    <ul>
                        <li>DataSetIdが自動的に付与されます（形式: INIT_YYYYMMDD_HHmmss_XXXXXX）</li>
                        <li>重複実行しても安全です（既存データは自動的に無効化）</li>
                        <li>トランザクション管理により、処理の原子性が保証されます</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="phase" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">
            <div class="phase-header">
                <div class="phase-number" style="background: white; color: #e74c3c;">🎯</div>
                <div class="phase-title" style="color: white;">Phase 2: 月初処理（6月1日）</div>
            </div>
            
            <div class="step" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h4 style="color: white;">Step 1: 前月末在庫を6月1日に引き継ぐ</h4>
                <div class="command-block">
<span class="comment"># import-with-carryoverで自動的に翌日（6/1）に引き継ぎ</span>
<span class="command-line">dotnet run import-with-carryover DeptA</span>
                </div>
                <p style="color: white; margin-top: 10px;">→ 最終処理日（5/31）の在庫を6/1に自動引継ぎ</p>
            </div>

            <div class="step" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h4 style="color: white;">Step 2: 6月1日の伝票データをインポート（ある場合）</h4>
                <div class="command-block">
<span class="comment"># 6月1日の伝票ファイルをImportフォルダに配置</span>
<span class="comment"># 売上伝票_20250601.csv, 仕入伝票_20250601.csv等</span>

<span class="comment"># インポート実行</span>
<span class="command-line">dotnet run import-folder DeptA 2025-06-01</span>
                </div>
            </div>

            <div class="step" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h4 style="color: white;">Step 3: 6月1日の帳票作成</h4>
                <div class="command-block">
<span class="comment"># アンマッチリスト</span>
<span class="command-line">dotnet run unmatch-list</span>

<span class="comment"># 商品日報</span>
<span class="command-line">.\dev.ps1 dev-daily-report 2025-06-01</span>

<span class="comment"># 在庫表（必要に応じて）</span>
<span class="command-line">dotnet run inventory-list 2025-06-01</span>
                </div>
            </div>
        </div>

        <div class="phase" style="background: linear-gradient(135deg, #27ae60 0%, #16a085 100%); color: white;">
            <div class="phase-header">
                <div class="phase-number" style="background: white; color: #27ae60;">🎯</div>
                <div class="phase-title" style="color: white;">Phase 3: 日次処理（6月2日以降）</div>
            </div>
            
            <div class="info" style="background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h4>📝 2つの処理方法</h4>
                <p>日次処理には2つの方法があります。状況に応じて使い分けてください。</p>
            </div>

            <div class="step" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h4 style="color: white;">オプション1: import-with-carryover使用（推奨）</h4>
                <div class="command-block">
<span class="comment"># 前日在庫を自動引き継ぎ + 当日伝票処理</span>
<span class="command-line">dotnet run import-with-carryover DeptA</span>

<span class="comment"># 帳票作成</span>
<span class="command-line">dotnet run unmatch-list</span>
<span class="command-line">.\dev.ps1 dev-daily-report 2025-06-02</span>
                </div>
                <div class="success" style="margin-top: 15px;">
                    <strong>メリット：</strong>
                    <ul>
                        <li>日付を自動判定（最終処理日の翌日を処理）</li>
                        <li>前日在庫と当日伝票を一括処理</li>
                        <li>日次終了処理が不要</li>
                    </ul>
                </div>
            </div>

            <div class="step" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h4 style="color: white;">オプション2: 従来の方法</h4>
                <div class="command-block">
<span class="comment"># 伝票データインポート</span>
<span class="command-line">dotnet run import-folder DeptA 2025-06-02</span>

<span class="comment"># 帳票作成</span>
<span class="command-line">dotnet run unmatch-list</span>
<span class="command-line">.\dev.ps1 dev-daily-report 2025-06-02</span>

<span class="comment"># 日次終了処理（在庫繰り越し）</span>
<span class="command-line">dotnet run dev-daily-close 2025-06-02</span>
                </div>
                <div class="warning" style="margin-top: 15px;">
                    <strong>注意：</strong>日次終了処理を忘れると、翌日の在庫計算に影響します
                </div>
            </div>
        </div>

        <div class="phase">
            <div class="phase-header">
                <div class="phase-number">3</div>
                <div class="phase-title">日次処理シミュレーション</div>
            </div>

            <div class="warning">
                <h4>🔴 在庫繰り越しの重要性</h4>
                <p><strong>日次終了処理（daily-close）</strong>は、在庫管理システムの核心機能です。</p>
                <ul>
                    <li><strong>目的：</strong>当日の在庫数量・金額を翌日の前日在庫として設定</li>
                    <li><strong>実行タイミング：</strong>商品日報作成後（通常15:00以降、開発ではいつでも可）</li>
                    <li><strong>未実行の影響：</strong>
                        <ul>
                            <li>翌日の前日在庫が0となり、全商品がアンマッチに</li>
                            <li>粗利計算が正しく行われない</li>
                            <li>在庫数量が負値になる可能性</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="info">
                <strong>📝 処理順序:</strong> import-folder → unmatch-list → daily-report → inventory-list → <span style="color: #e74c3c; font-weight: bold;">daily-close</span>
                <br><br>
                <strong>💡 注意:</strong> import-folderコマンドは前月末在庫.csvを自動的にスキップします。前月末在庫の設定は必ずinit-inventoryコマンドを使用してください。
                <br><br>
                <strong>🔵 重要な変更:</strong> unmatch-listコマンドは日付パラメータが不要になりました。全期間の伝票データを対象に累積管理を行います。
                <br><br>
                <strong>🔴 最重要:</strong> 各日の処理の最後に必ず<strong>dev-daily-close</strong>（日次終了処理）を実行してください。これにより当日在庫が翌日の前日在庫として繰り越されます。
                <br><br>
                <strong>📝 注意:</strong> 「データが存在しません」エラーが出た場合は、先にデータインポートを実行するか、<code>--skip-validation</code>オプションを使用してください。
            </div>

            <div class="timeline">
                <div class="timeline-item">
                    <h4>初回処理前の準備（マスタデータ確認）</h4>
                    <div class="info" style="margin-bottom: 15px;">
                        <strong>重要：</strong> 初回処理前に、マスタデータがインポートされているか確認してください。
                    </div>
                    <div class="command-block">
<span class="comment"># マスタデータ確認（コマンドラインから実行）</span>
<span class="command-line">dotnet run check-masters</span>
                    </div>
                    <p style="margin-top: 10px;">または、SQL Server Management Studio で以下のクエリを個別に実行：</p>
                    <div class="command-block">
<span class="comment">-- 各マスタテーブルの件数確認</span>
<span class="command-line">SELECT COUNT(*) as 商品マスタ件数 FROM ProductMaster</span>
<span class="command-line">SELECT COUNT(*) as 得意先マスタ件数 FROM CustomerMaster</span>
<span class="command-line">SELECT COUNT(*) as 仕入先マスタ件数 FROM SupplierMaster</span>
<span class="command-line">SELECT COUNT(*) as 等級マスタ件数 FROM GradeMaster</span>
<span class="command-line">SELECT COUNT(*) as 階級マスタ件数 FROM ClassMaster</span>
                    </div>
                    <div class="warning" style="margin-top: 15px;">
                        <strong>⚠️ 注意：</strong> import-folderコマンドを使用すると、マスタファイルと一緒に伝票データもインポートされます。初回処理では必ず日付を指定してください。
                    </div>
                </div>

                <div class="timeline-item">
                    <h4>6月1日の処理</h4>
                    <div class="command-block">
<span class="comment"># 6月1日の伝票データインポート（マスタファイルも同時にインポートされます）</span>
<span class="command-line">dotnet run import-folder DeptA 2025-06-01</span>

<span class="comment"># アンマッチリスト作成（在庫マスタ更新）※全期間対象</span>
<span class="command-line">dotnet run unmatch-list</span>

<span class="comment"># 商品日報作成（通常版 - 7日以内の制限あり）</span>
<span class="command-line">dotnet run daily-report 2025-06-01</span>

<span class="comment"># または開発用コマンド（PowerShellスクリプト経由 - 推奨）</span>
<span class="command-line">.\dev.ps1 dev-daily-report 2025-06-01</span>

<span class="comment"># 在庫表作成（必要に応じて）</span>
<span class="command-line">dotnet run inventory-list 2025-06-01</span>

<span class="comment"># 日次終了処理の事前確認（通常版 - 15:00以降の制限あり）</span>
<span class="command-line">dotnet run check-daily-close 2025-06-01</span>

<span class="comment"># または開発用コマンド（PowerShellスクリプト経由 - 推奨）</span>
<span class="command-line">.\dev.ps1 dev-check-daily-close 2025-06-01</span>

<span class="comment"># 日次終了処理（在庫繰り越し）※重要</span>
<span class="command-line">dotnet run dev-daily-close 2025-06-01</span>
                    </div>
                    <div class="warning" style="margin-top: 15px;">
                        <strong>⚠️ 重要：日次終了処理について</strong>
                        <ul>
                            <li>日次終了処理により、当日の在庫が翌日の前日在庫として設定されます</li>
                            <li>この処理を行わないと、翌日のアンマッチが大量に発生します</li>
                            <li><strong>コマンド：</strong> <code>dev-daily-close</code>（開発用、時間制約なし）</li>
                            <li><strong>事前確認：</strong> <code>check-daily-close</code>で実行可能か確認可能</li>
                            <li><strong>オプション：</strong> <code>--skip-validation</code>でデータチェックをスキップ</li>
                            <li>本番環境では15:00以降に実行（開発環境では時間制約なし）</li>
                        </ul>
                    </div>
                </div>

                <div class="timeline-item">
                    <h4>6月2日の処理</h4>
                    <div class="command-block">
<span class="comment"># 6月2日の処理（開発環境）</span>
<span class="command-line">dotnet run import-folder DeptA 2025-06-02</span>
<span class="command-line">dotnet run unmatch-list</span>
<span class="command-line">.\dev.ps1 dev-daily-report 2025-06-02</span>
<span class="command-line">.\dev.ps1 dev-daily-close 2025-06-02</span>
                    </div>
                </div>

                <div class="timeline-item">
                    <h4>6月3日の処理</h4>
                    <div class="command-block">
<span class="comment"># 6月3日の処理（開発環境）</span>
<span class="command-line">dotnet run import-folder DeptA 2025-06-03</span>
<span class="command-line">dotnet run unmatch-list</span>
<span class="command-line">.\dev.ps1 dev-daily-report 2025-06-03</span>
<span class="command-line">.\dev.ps1 dev-daily-close 2025-06-03</span>
                    </div>
                </div>

                <div class="timeline-item">
                    <h4>継続処理</h4>
                    <p><strong>必要な日付まで上記の手順を継続してください。</strong></p>
                    <p>最大で6月27日まで処理可能です。</p>
                </div>
            </div>
            
            <!-- 開発用コマンドのセクション追加 -->
            <div class="info" style="background: rgba(155, 89, 182, 0.1); border-left: 4px solid #9b59b6;">
                <h3 style="margin-top: 0;">🛠️ 開発環境用コマンド</h3>
                <p><strong>開発環境での制限解除について：</strong></p>
                <ul style="margin: 10px 0;">
                    <li><strong>日付制限：</strong> 7日以内の制限なし（過去の任意の日付を処理可能）</li>
                    <li><strong>時間制限：</strong> 15:00以降の制限なし（任意の時刻に実行可能）</li>
                </ul>
                
                <h4 style="margin-top: 20px;">⚡ PowerShellスクリプトを使用した実行（推奨）</h4>
                <div class="success" style="margin: 15px 0;">
                    <p><strong>dev.ps1スクリプトを使用することで、環境変数が自動的に設定されます：</strong></p>
                    <div class="command-block">
<span class="comment"># ディレクトリに移動</span>
<span class="command-line">cd C:\Development\InventoryManagementSystem\src\InventorySystem.Console</span>

<span class="comment"># 開発用商品日報（過去日付OK）</span>
<span class="command-line">.\dev.ps1 dev-daily-report 2025-06-01</span>

<span class="comment"># 開発用日次終了確認（時間制限なし）</span>
<span class="command-line">.\dev.ps1 dev-check-daily-close 2025-06-01</span>

<span class="comment"># 開発用日次終了処理</span>
<span class="command-line">.\dev.ps1 dev-daily-close 2025-06-01</span>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">開発用コマンド一覧</h4>
                <table style="width: 100%; margin: 15px 0; border-collapse: collapse; background: white;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 10px; text-align: left;">コマンド</th>
                            <th style="padding: 10px; text-align: left;">通常版との違い</th>
                            <th style="padding: 10px; text-align: left;">使用例（dev.ps1経由）</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 10px;"><code>dev-daily-report</code></td>
                            <td style="padding: 10px;">日付制限なし（7日以上前も処理可能）</td>
                            <td style="padding: 10px;"><code>.\dev.ps1 dev-daily-report 2025-06-01</code></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 10px;"><code>dev-check-daily-close</code></td>
                            <td style="padding: 10px;">時間制限なし（15:00前でも実行可能）</td>
                            <td style="padding: 10px;"><code>.\dev.ps1 dev-check-daily-close 2025-06-01</code></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 10px;"><code>dev-daily-close</code></td>
                            <td style="padding: 10px;">検証スキップ、時間制限なし</td>
                            <td style="padding: 10px;"><code>.\dev.ps1 dev-daily-close 2025-06-01</code></td>
                        </tr>
                    </tbody>
                </table>
                
                <h4 style="margin-top: 20px;">手動での環境変数設定（代替方法）</h4>
                <div class="command-block">
<span class="comment"># PowerShellで環境変数を設定</span>
<span class="command-line">$env:DOTNET_ENVIRONMENT = "Development"</span>
<span class="command-line">$env:ASPNETCORE_ENVIRONMENT = "Development"</span>

<span class="comment"># その後、開発用コマンドを実行</span>
<span class="command-line">dotnet run dev-daily-report 2025-06-01</span>
                </div>
                
                <div class="warning" style="margin-top: 20px;">
                    <strong>⚠️ 重要な注意事項</strong>
                    <ul>
                        <li><strong style="color: #e74c3c;">必ず dev.ps1 スクリプト経由で実行してください</strong></li>
                        <li>直接 <code>dotnet run</code> を実行すると、Production環境として動作します</li>
                        <li>本番環境では開発用コマンドは自動的に無効化されます</li>
                        <li>環境変数の確認: <code>echo $env:DOTNET_ENVIRONMENT</code></li>
                    </ul>
                </div>
            </div>

            <div class="success">
                <strong>💡 PowerShell一括実行スクリプト例（開発環境）:</strong>
                <div class="command-block">
<span class="comment"># 環境変数を設定（一括処理の前に実行）</span>
<span class="command-line">$env:DOTNET_ENVIRONMENT = "Development"</span>
<span class="command-line">$env:ASPNETCORE_ENVIRONMENT = "Development"</span>

<span class="comment"># PowerShell一括実行例（日次終了処理を含む）</span>
<span class="command-line">for ($i=1; $i -le 7; $i++) {</span>
<span class="command-line">    $date = "2025-06-$('{0:D2}' -f $i)"</span>
<span class="command-line">    Write-Host "=== $date の処理開始 ===" -ForegroundColor Cyan</span>
<span class="command-line">    dotnet run import-folder DeptA $date</span>
<span class="command-line">    dotnet run unmatch-list  <span class="comment"># 日付不要（全期間対象）</span></span>
<span class="command-line">    .\dev.ps1 dev-daily-report $date  <span class="comment"># 開発用（日付制限なし）</span></span>
<span class="command-line">    .\dev.ps1 dev-daily-close $date   <span class="comment"># 在庫繰り越し（重要）</span></span>
<span class="command-line">    Write-Host "=== $date の処理完了 ===" -ForegroundColor Green</span>
<span class="command-line">}</span>
                </div>
                
                <p style="margin-top: 10px;"><strong>💡 ヒント:</strong> 開発用コマンドを使用する場合は、必ず <code>.\dev.ps1</code> 経由で実行してください。</p>
            </div>
        </div>

        <div class="phase">
            <div class="phase-header">
                <div class="phase-number">4</div>
                <div class="phase-title">月間処理確認</div>
            </div>

            <div class="step">
                <h4>月中任意日での確認</h4>
                <div class="command-block">
<span class="comment"># 月中の状況確認</span>
<span class="command-line">dotnet run daily-report 2025-06-15</span>
<span class="command-line">dotnet run check-data-status 2025-06-15</span>
                </div>
            </div>

            <div class="step">
                <h4>月末での確認</h4>
                <div class="command-block">
<span class="comment"># 月末の最終確認</span>
<span class="command-line">dotnet run daily-report 2025-06-27</span>
<span class="command-line">dotnet run inventory-list 2025-06-27</span>
                </div>
            </div>
        </div>

        <div class="verification">
            <h3>🔍 検証ポイント</h3>
            
            <h4>1. データ継続性の確認</h4>
            <table>
                <thead>
                    <tr>
                        <th>確認項目</th>
                        <th>SQLクエリ例</th>
                        <th>期待値</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>在庫マスタ件数</td>
                        <td>SELECT COUNT(*) FROM InventoryMaster WHERE JobDate = '2025-06-01'</td>
                        <td>1,500件程度</td>
                    </tr>
                    <tr>
                        <td>売上伝票件数</td>
                        <td>SELECT COUNT(*) FROM SalesVouchers WHERE JobDate = '2025-06-01'</td>
                        <td>500-1,200件</td>
                    </tr>
                    <tr>
                        <td>在庫継続性</td>
                        <td>前日在庫 + 当日仕入 - 当日売上 = 当日在庫</td>
                        <td>数式一致</td>
                    </tr>
                </tbody>
            </table>

            <h4>2. 計算精度の確認</h4>
            <div class="command-block">
<span class="comment">-- 粗利計算確認（SQL Server Management Studioで実行）</span>
<span class="command-line">SELECT TOP 10</span>
<span class="command-line">    ProductCode, GradeCode,</span>
<span class="command-line">    PreviousDayAmount,</span>
<span class="command-line">    CurrentDayPurchaseAmount,</span>
<span class="command-line">    CurrentDayAmount,</span>
<span class="command-line">    CurrentDayGrossProfit</span>
<span class="command-line">FROM InventoryMaster</span>
<span class="command-line">WHERE JobDate = '2025-06-01' AND CurrentDayGrossProfit <> 0</span>
<span class="command-line">ORDER BY CurrentDayGrossProfit DESC</span>
            </div>
        </div>

        <div class="troubleshooting">
            <h3>🛠️ よくある問題と対処法</h3>

            <h4>❌ 問題1: 前月末在庫が設定されない（商品マスタ未登録エラー）</h4>
            <div class="step">
                <strong>原因:</strong> 商品マスタがインポートされていない
                <div class="command-block">
<span class="comment"># 対処法: マスタデータを先にインポート</span>
<span class="command-line">dotnet run import-folder DeptA  # マスタファイルのみインポート</span>
                </div>
                <div class="command-block">
<span class="comment"># 商品マスタ確認（SQL Server Management Studioで実行）</span>
<span class="command-line">SELECT COUNT(*) as 商品マスタ件数 FROM ProductMaster</span>
                </div>
                <div class="command-block">
<span class="comment"># その後、初期在庫設定</span>
<span class="command-line">dotnet run init-inventory DeptA</span>
                </div>
            </div>

            <h4>❌ 問題1-2: import-folderを使用している</h4>
            <div class="step">
                <strong>原因:</strong> import-folderコマンドは前月末在庫.csvをスキップする仕様
                <div class="command-block">
<span class="comment"># 対処法: 正しいコマンドを使用</span>
<span class="command-line">dotnet run init-inventory DeptA</span>
<span class="comment"># ファイル存在確認</span>
<span class="command-line">dir D:\InventoryImport\DeptA\Import\前月末在庫.csv</span>
                </div>
            </div>

            <h4>❌ 問題2: 商品日報にデータが表示されない</h4>
            <div class="step">
                <strong>原因:</strong> 初期在庫未設定、または在庫マスタが空
                <div class="command-block">
<span class="comment"># 対処法</span>
<span class="command-line">dotnet run init-inventory DeptA</span>
<span class="command-line">dotnet run check-data-status 2025-06-01</span>
<span class="command-line">dotnet run unmatch-list</span>
                </div>
            </div>

            <h4>❌ 問題2-2: 翌日のアンマッチが大量発生</h4>
            <div class="step">
                <strong>原因:</strong> 前日の日次終了処理（在庫繰り越し）未実行
                <div class="command-block">
<span class="comment"># 対処法1: 前日の日次終了処理を実行</span>
<span class="command-line">dotnet run dev-daily-close 2025-06-01  # 前日分を実行</span>
<span class="comment"># その後、当日の処理を再実行</span>
<span class="command-line">dotnet run unmatch-list</span>
                </div>
                <div class="command-block">
<span class="comment"># 対処法2: import-with-carryoverコマンドを使用（推奨）</span>
<span class="command-line">dotnet run import-with-carryover DeptA</span>
<span class="comment"># このコマンドは最終処理日の在庫を自動的に引き継ぎます</span>
                </div>
            </div>

            <h4>❌ 問題2-3: 日次終了処理で「データが存在しません」エラー</h4>
            <div class="step">
                <strong>原因:</strong> 指定日付の売上・仕入・在庫調整データが存在しない
                <div class="command-block">
<span class="comment"># 対処法１: データの存在確認</span>
<span class="command-line">dotnet run check-data-status 2025-06-01</span>
                </div>
                <div class="command-block">
<span class="comment"># 対処法２: データがない場合は先にインポート</span>
<span class="command-line">dotnet run import-folder DeptA 2025-06-01</span>
<span class="command-line">dotnet run unmatch-list</span>
<span class="command-line">dotnet run daily-report 2025-06-01</span>
                </div>
                <div class="command-block">
<span class="comment"># 対処法３: バリデーションをスキップして実行</span>
<span class="command-line">dotnet run dev-daily-close 2025-06-01 --skip-validation</span>
                </div>
            </div>

            <h4>❌ 問題3: アンマッチ件数が多い</h4>
            <div class="step">
                <strong>原因:</strong> マスタ未登録データ（等級コード「000」、荷印コード「8001」等）
                <div class="command-block">
<span class="comment"># 対処法: マスタ確認</span>
<span class="command-line">dotnet run check-masters</span>
                </div>
            </div>

            <h4>❌ 問題4: FastReport関連エラー</h4>
            <div class="step">
                <strong>原因:</strong> Windows環境での実行エラー
                <div class="command-block">
<span class="comment"># 対処法: Windows環境での実行</span>
<span class="command-line">dotnet run -c Debug -p:DefineConstants="WINDOWS" -- daily-report 2025-06-01</span>
                </div>
            </div>
        </div>

        <div class="info">
            <h3>📋 パフォーマンス目標</h3>
            <table>
                <thead>
                    <tr>
                        <th>処理項目</th>
                        <th>現状</th>
                        <th>目標</th>
                        <th>改善率</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>データ取込</td>
                        <td>5分</td>
                        <td>2分</td>
                        <td>60%短縮</td>
                    </tr>
                    <tr>
                        <td>アンマッチ処理</td>
                        <td>12分</td>
                        <td>3分</td>
                        <td>75%短縮</td>
                    </tr>
                    <tr>
                        <td>帳票出力</td>
                        <td>10分</td>
                        <td>5分</td>
                        <td>50%短縮</td>
                    </tr>
                    <tr>
                        <td>在庫計算</td>
                        <td>15分</td>
                        <td>5分</td>
                        <td>67%短縮</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="phase">
            <div class="phase-header">
                <div class="phase-number">✓</div>
                <div class="phase-title">シミュレーション完了チェックリスト</div>
            </div>

            <div class="step">
                <h4>□ 環境準備完了</h4>
                <ul>
                    <li>□ データベース初期化済み</li>
                    <li>□ 接続確認済み</li>
                </ul>
            </div>

            <div class="step">
                <h4>□ 初期在庫設定完了</h4>
                <ul>
                    <li>□ init-inventoryコマンドで前月末在庫.csvインポート済み</li>
                    <li>□ 在庫マスタに初期在庫が設定済み</li>
                    <li>□ SQL実行で初期在庫データ確認済み</li>
                </ul>
            </div>

            <div class="step">
                <h4>□ 日次処理動作確認完了</h4>
                <ul>
                    <li>□ マスタデータインポート済み（初回のimport-folderで自動インポート）</li>
                    <li>□ 商品マスタ登録確認済み（ProductMasterテーブルにデータあり）</li>
                    <li>□ 6月1日〜3日の連続処理確認済み</li>
                    <li>□ アンマッチリスト正常生成</li>
                    <li>□ 商品日報正常生成</li>
                    <li>□ 在庫表正常生成</li>
                    <li>□ 日次終了処理による在庫繰り越し確認済み</li>
                </ul>
            </div>

            <div class="step">
                <h4>□ 拡張テスト完了</h4>
                <ul>
                    <li>□ 1週間分の連続処理確認済み</li>
                    <li>□ パフォーマンス測定済み</li>
                    <li>□ エラーハンドリング確認済み</li>
                </ul>
            </div>
        </div>

        <!-- Phase 4: 実行例 -->
        <div class="phase">
            <div class="phase-header">
                <div class="phase-number">4</div>
                <div class="phase-title">実行例（6月1日〜3日）- 伝票の有無による処理フロー</div>
            </div>
            
            <div class="info" style="margin-bottom: 20px;">
                <h4>📌 コマンドの役割整理</h4>
                <table style="width: 100%; margin-top: 10px;">
                    <tr style="background: rgba(52, 152, 219, 0.2);">
                        <th style="padding: 10px; text-align: left;">コマンド</th>
                        <th style="padding: 10px; text-align: left;">用途</th>
                        <th style="padding: 10px; text-align: left;">実行タイミング</th>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><code>import-folder</code></td>
                        <td style="padding: 10px;">伝票がある日の取込</td>
                        <td style="padding: 10px;">朝</td>
                    </tr>
                    <tr style="background: rgba(46, 204, 113, 0.1);">
                        <td style="padding: 10px;"><code>import-with-carryover</code></td>
                        <td style="padding: 10px;">伝票がない日の在庫引継</td>
                        <td style="padding: 10px;">朝</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><code>daily-close</code></td>
                        <td style="padding: 10px;">日次終了処理（共通）</td>
                        <td style="padding: 10px;">夕方</td>
                    </tr>
                </table>
            </div>
            
            <div class="example-section">
                <h4>📅 6月1日（土曜日）- 伝票データが一切ない日の処理</h4>
                <div class="warning" style="margin-bottom: 15px;">
                    <strong>⚠️ 重要：</strong>6月1日は土曜日のため、売上・仕入・在庫調整の伝票データは一切ありません。CSVファイルも存在しません。
                </div>
                <div class="step" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h5 style="color: #3498db;">1. 朝：在庫引継のみ実行</h5>
                    <div class="command-block">
                        <span class="comment"># 前日（5/31）の在庫166件を6/1付けで引き継ぎ</span>
                        <span class="comment"># 6/1の伝票CSVファイルは存在しないため、import-folderは使用不可</span>
                        <span class="comment"># import-with-carryoverで前日在庫を引き継ぐだけ</span>
                        <span class="command-line">dotnet run -- import-with-carryover DeptA</span>
                    </div>
                    
                    <h5 style="color: #3498db; margin-top: 20px;">2. 日中：各種帳票作成（在庫のみ）</h5>
                    <div class="command-block">
                        <span class="comment"># アンマッチリスト（CP在庫マスタ作成）</span>
                        <span class="comment"># 売上・仕入データなし、在庫166件のみ</span>
                        <span class="command-line">dotnet run -- create-unmatch-list 2025-06-01</span>
                        <br><br>
                        <span class="comment"># 商品日報（売上0円、仕入0円、在庫166件）</span>
                        <span class="command-line">.\dev.ps1 dev-daily-report 2025-06-01</span>
                        <br><br>
                        <span class="comment"># 在庫表（前日から引き継いだ166件の在庫を表示）</span>
                        <span class="command-line">dotnet run -- inventory-list 2025-06-01</span>
                    </div>
                    
                    <h5 style="color: #3498db; margin-top: 20px;">3. 夕方：日次終了処理</h5>
                    <div class="command-block">
                        <span class="comment"># CP在庫マスタを削除し、翌日（6/2）への準備</span>
                        <span class="command-line">dotnet run -- daily-close 2025-06-01</span>
                    </div>
                </div>
                
                <h4>📅 6月2日（日曜日）- 伝票がある日の処理</h4>
                <div class="step" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h5 style="color: #27ae60;">1. 朝：伝票取込</h5>
                    <div class="command-block">
                        <span class="comment"># CSVファイルから伝票データをインポート</span>
                        <span class="command-line">dotnet run -- import-folder DeptA 2025-06-02</span>
                    </div>
                    
                    <h5 style="color: #27ae60; margin-top: 20px;">2. 日中：帳票作成（同じ流れ）</h5>
                    <div class="command-block">
                        <span class="comment"># アンマッチリスト</span>
                        <span class="command-line">dotnet run -- create-unmatch-list 2025-06-02</span>
                        <br><br>
                        <span class="comment"># 商品日報</span>
                        <span class="command-line">.\dev.ps1 dev-daily-report 2025-06-02</span>
                        <br><br>
                        <span class="comment"># 在庫表</span>
                        <span class="command-line">dotnet run -- inventory-list 2025-06-02</span>
                    </div>
                    
                    <h5 style="color: #27ae60; margin-top: 20px;">3. 夕方：日次終了処理（共通）</h5>
                    <div class="command-block">
                        <span class="command-line">dotnet run -- daily-close 2025-06-02</span>
                    </div>
                </div>
                
                <h4>📅 6月3日（月曜日）- 営業日の処理</h4>
                <div class="command-block">
                    <span class="comment"># 通常の営業日は import-folder を使用</span>
                    <span class="command-line">dotnet run -- import-folder DeptA 2025-06-03</span>
                    <br><br>
                    <span class="comment"># 以降、帳票作成と日次終了処理</span>
                    <span class="command-line"># （省略）</span>
                </div>
            </div>
            
            <div class="warning" style="margin-top: 20px;">
                <h4>🚨 重要なポイント</h4>
                <ul>
                    <li><strong>帳票は毎日作成</strong> - 伝票がなくても在庫状況の帳票は必要（売上・仕入が0円でも記録として残す）</li>
                    <li><strong>在庫の連続性を保つ</strong> - 伝票がない日も在庫データは引き継ぐ（JobDateを更新して管理）</li>
                    <li><strong>日次終了処理は共通</strong> - 伝票の有無に関わらず`daily-close`を実行（CP在庫マスタの削除など必要な処理）</li>
                    <li><strong>import-with-carryoverは伝票取込用</strong> - 日次終了は別途`daily-close`コマンドで実行</li>
                </ul>
            </div>
        </div>
        
        <!-- Important Points -->
        <div class="phase">
            <div class="phase-header">
                <div class="phase-number">💡</div>
                <div class="phase-title">重要なポイント</div>
            </div>
            
            <div class="info">
                <ul>
                    <li><strong>初期在庫の重要性</strong>: init-inventoryで正確な前月末在庫を設定することが、その後の全処理の基盤となります</li>
                    <li><strong>累積管理の利点</strong>: import-with-carryoverは前日在庫を自動的に引き継ぐため、データの連続性が保証されます</li>
                    <li><strong>処理の選択</strong>: 
                        <ul>
                            <li>通常はimport-with-carryoverを使用（安全・確実）</li>
                            <li>特定日のデータを再処理する場合のみimport-folderを使用</li>
                        </ul>
                    </li>
                    <li><strong>エラー対策</strong>: import-with-carryoverで「前月末在庫が見つかりません」エラーが出た場合は、init-inventoryの実行を確認</li>
                </ul>
            </div>
        </div>
        
        <!-- Caution Section -->
        <div class="phase" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">
            <div class="phase-header">
                <div class="phase-number" style="background: white; color: #e74c3c;">🚨</div>
                <div class="phase-title" style="color: white;">注意事項</div>
            </div>
            
            <div class="warning" style="background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h4 style="color: white;">❌ やってはいけないこと</h4>
                <ul style="color: white;">
                    <li>init-inventoryを実行せずに6月1日の処理を開始する</li>
                    <li>日付を飛ばしてimport-with-carryoverを実行する（例：6/1の次に6/3を処理）</li>
                    <li>同じ日付で複数回import-folderを実行する（重複データの原因）</li>
                </ul>
                
                <h4 style="color: white;">✅ 推奨される運用</h4>
                <ul style="color: white;">
                    <li>毎日定時にimport-with-carryoverを実行</li>
                    <li>処理漏れがあった場合は、漏れた日から順番に処理</li>
                    <li>データ修正が必要な場合は、該当日以降を再処理</li>
                </ul>
            </div>
        </div>

        <div class="header" style="margin-top: 50px; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 10px;">
            <p><strong>🎯 この手順により、安全で確実な在庫管理が実現できます</strong></p>
            <p>初期導入から日次処理まで、段階的に進めることで確実な運用が可能です</p>
            <br>
            <button class="button" onclick="window.print()">📄 この手順書を印刷</button>
        </div>
    </div>

    <script>
        // ページ読み込み時のアニメーション
        window.addEventListener('load', function() {
            const phases = document.querySelectorAll('.phase');
            phases.forEach((phase, index) => {
                setTimeout(() => {
                    phase.style.opacity = '0';
                    phase.style.transform = 'translateY(20px)';
                    phase.style.transition = 'all 0.6s ease';
                    
                    setTimeout(() => {
                        phase.style.opacity = '1';
                        phase.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 200);
            });
        });

        // コマンドブロックのクリックでコピー機能
        document.querySelectorAll('.command-block').forEach(block => {
            block.addEventListener('click', function() {
                const text = this.textContent.replace(/PowerShell/g, '').trim();
                navigator.clipboard.writeText(text).then(() => {
                    const originalBg = this.style.background;
                    this.style.background = '#2ecc71';
                    setTimeout(() => {
                        this.style.background = originalBg;
                    }, 500);
                });
            });
        });
    </script>
</body>
</html>