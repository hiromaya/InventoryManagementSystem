# 在庫管理システム処理フロー詳細

## 1. アンマッチリスト処理

### 処理1-1: CP在庫M作成
- **目的**: 在庫Mをコピーしてコピー済み在庫M（CP在庫M）を作成
- **処理内容**: 
  - 在庫マスタの完全コピーを作成
  - 元の在庫Mは保持したまま、作業用のCP在庫Mで処理を実行

### 処理1-2: 当日エリアクリアと集計
#### クリア処理
- **対象項目**（当日エリア）:
  - 仕入・仕入返品
  - 売上・売上返品
  - 在庫調整
  - 加工・振替
  - 粗利益
  - 仕入値引
  - 完納奨励金
  - 歩引き金
  - 入庫・出庫
- **設定**: 当日発生フラグ = '9'（未処理）

#### 当日データ集計条件
| 伝票種類 | 伝票種 | 明細種 | 数量条件 | 集計先 |
|----------|--------|--------|----------|--------|
| 売上伝票 | 51, 52 | 1, 2 | 数量 < 0 | 当日売上数量 |
| 仕入伝票 | 11, 12 | 1, 2 | 数量 > 0 | 当日仕入数量 |
| 在庫調整 | 71, 72 | 1, 3, 4 | 数量 > 0 | 当日在庫調整数量 |

- **処理後**: 
  - 最新更新日 = 本日日付
  - 当日発生フラグ = '0'（処理済）

### 処理1-3: 当日在庫計算
```
当日在庫数量 = 前日在庫数量 + 当日仕入数量 + 当日在庫調整数量 - 当日売上数量
```

### 処理1-6: アンマッチリスト出力

#### アンマッチ判定条件

##### 売上伝票のアンマッチ
1. **在庫0エラー**: 
   - 条件: CP在庫Mの「前日在庫数量 ≧ 0」かつ「当日在庫数量 = 0」
   - アラート: "在庫0"
2. **該当無エラー**: 
   - 条件: CP在庫Mにキーが存在しない
   - アラート: "該当無"

##### 仕入伝票のアンマッチ
1. **在庫0エラー**: 
   - 条件: CP在庫Mの「当日在庫数量 = 0」
   - アラート: "在庫0"
2. **該当無エラー**: 
   - 条件: CP在庫Mにキーが存在しない
   - アラート: "該当無"

##### 在庫調整のアンマッチ
1. **在庫0エラー**: 
   - 条件: CP在庫Mの「前日在庫数量 = 0」かつ「在庫調整の数量 < 0」
   - アラート: "在庫0"

#### 共通仕様
- 数量が0の行は処理しない
- アンマッチデータがある場合: エラー行と合計件数を印字
- アンマッチデータがない場合: "アンマッチデータなし"と印字

---

## 2. 商品勘定計算処理

### 処理2-1: CP在庫M作成（アンマッチと同様）
- 在庫Mをコピー
- 当日エリアのクリア
- 当日発生フラグ = '9'

### 処理2-2: 当日データ集計（除外条件付き）

#### 除外条件
- 荷印名（手入力）の先頭4文字が 'EXIT' または 'exit' の行
- 荷印コードが '9900', '9910', '1353' の行

#### 集計条件
| 伝票種類 | 伝票種 | 明細種 | 備考 |
|----------|--------|--------|------|
| 売上伝票 | 51, 52 | 1, 2, 3 | 明細種3も含む |
| 仕入伝票 | 11, 12 | 1, 2, 3 | 明細種3も含む |
| 在庫調整 | 71, 72 | 1, 3, 4 | 同上 |

#### 売上・仕入伝票の集計ルール
| 取引種別 | CP在庫M集計先1 | CP在庫M集計先2 |
|----------|----------------|----------------|
| 掛売上・現金売上 | 当日売上（数量・金額） | 当日出荷（数量・金額） |
| 掛売上返品 | 当日売上返品（数量・金額） | 当日出荷（数量・金額） |
| 掛買・現金買 | 当日仕入（数量・金額） | 当日入荷（数量・金額） |
| 掛買返品 | 当日仕入返品（数量・金額） | 当日入荷（数量・金額） |
| 仕入値引 | 当日仕入値引き金額 | - |

#### 在庫調整の単位コード別集計
| 単位コード | CP在庫M集計先1 | CP在庫M集計先2 |
|------------|----------------|----------------|
| 01, 03, 06 | 当日在庫調整（数量・金額） | 当日入荷（数量・金額） |
| 02, 05 | 当日加工（数量・金額） | 当日入荷（数量・金額） |
| 04 | 当日振替（数量・金額） | 当日入荷（数量・金額） |

### 処理2-3: 商品分類1の例外処理（特殊処理）

| 荷印名先頭4文字 | 商品分類1の値 |
|-----------------|---------------|
| 9aaa | 8 |
| 1aaa | 6 |
| 0999 | 6 |

### 処理2-4: 在庫の諸計算

#### 在庫計算式
1. **(仮)在庫数** = 前日在庫数 + 当日入荷数
2. **(仮)在庫金額** = 前日在庫金額 + 当日入荷金額
3. **当日在庫単価** = (仮)在庫金額 ÷ (仮)在庫数  
   ※小数点第5位四捨五入
4. **当日在庫数** = 前日在庫数 + 当日入荷数 - 当日出荷数
5. **当日在庫金額** = 当日在庫数 × 当日在庫単価  
   ※小数点第5位四捨五入

#### 粗利益の修正計算
```
当日粗利益（修正後） = 当日粗利益 - 当日在庫調整金額 - 当日加工費
```

### 処理2-5: 歩引き金計算と粗利付込

1. **売上伝票への粗利益付込**
   - 売上伝票を読込
   - CP在庫Mの当日在庫単価を使用して粗利益を計算
   - 計算した粗利益を売上伝票の1行ごとに書き込み
   - 同時にCP在庫Mの当日粗利益に集計

2. **歩引き金計算**
   - 売上伝票の得意先コードで得意先マスタを参照
   - 歩引き金額 = 売上金額 × 歩引き率
   - CP在庫Mの当日歩引き額に集計

### 処理2-6: 奨励金計算

- **対象**: 仕入先分類1 = '01' の仕入伝票
- **計算式**: 奨励金 = 仕入金額 × 1%
- **集計先**: CP在庫Mの当日奨励金

---

## 3. 後続処理

### 処理3-1: 商品勘定作成
- CP在庫M、商品M、売上伝票、仕入伝票、在庫調整を使用

### 処理4-1: 商品日報作成
- CP在庫M、商品Mを使用

### 処理5-1: 在庫表（残品表）作成
- CP在庫M、商品Mを使用

---

## 処理の特徴

1. **CP在庫Mの活用**
   - 元データを保護しながら処理を実行
   - 各処理（アンマッチ、商品勘定、商品日報、在庫表）で毎回新規作成

2. **2段階の処理**
   - アンマッチリスト: 基本的な整合性チェック
   - 商品勘定計算: 除外条件と特殊処理を含む詳細計算

3. **フラグ管理**
   - 当日発生フラグで処理状態を管理（'9'→'0'）

4. **0除算対策**
   - 在庫単価計算時に(仮)在庫数のチェックが必要