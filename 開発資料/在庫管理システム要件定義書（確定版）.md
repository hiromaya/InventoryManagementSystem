# 在庫管理システム要件定義書（確定版）

## 1. CSV仕様

### 1.1 CSVファイル形式
| 項目 | 仕様 |
|------|------|
| 文字コード | **UTF-8** |
| 区切り文字 | カンマ |
| ヘッダー行 | あり |
| 改行コード | CRLF |

### 1.2 CSVファイル種類
- 売上伝票CSV
- 仕入伝票CSV
- 在庫調整CSV
- 商品マスタCSV
- 得意先マスタCSV
- 仕入先マスタCSV

※サンプルファイルは2025年6月17日提供予定

### 1.3 CSV出力仕様
- **出力場所**: `D:\Share\AddonData`
- **ファイル名**: `[テーブル名].csv`
- **出力タイミング**: ユーザ操作時

## 2. キー構造（重要：確定版）

### 2.1 5項目複合キー
| 項目名 | データ型 | 桁数 | 例 | 備考 |
|--------|----------|------|-----|------|
| 商品コード | 文字列 | **5** | 00001 | 数字 |
| 等級コード | 文字列 | **3** | 001 | 数字 |
| 階級コード | 文字列 | **3** | 001 | 数字 |
| 荷印コード | 文字列 | **4** | 0001 | 数字 |
| 荷印名 | 文字列 | **8** | ABCｱｲｳｴｵ | 半角8文字で英数字 |

※注意：在庫マスタ定義書とは桁数が異なる（実運用はこちらを使用）

## 3. コード体系

### 3.1 伝票種別コード
| コード | 意味 | 伝票種類 | 備考 |
|--------|------|----------|------|
| 51 | 掛売上 | 売上伝票 | |
| 52 | 現金売上 | 売上伝票 | |
| 11 | 掛仕入（掛買） | 仕入伝票 | |
| 12 | 現金仕入（現金買） | 仕入伝票 | |
| 71 | 受注掛売 | 在庫調整 | 伝票種別は無視 |
| 72 | 受注現金売 | 在庫調整 | 伝票種別は無視 |

### 3.2 明細種別コード
| コード | 売上伝票 | 仕入伝票 | 在庫調整 | 備考 |
|--------|----------|----------|----------|------|
| 1 | 売上 | 仕入 | 無視 | |
| 2 | 返品 | 返品 | 無視 | |
| 3 | 単品値引 | 単品値引 | 無視 | 在庫調整は単位コードで判断 |
| 4 | 値引 | 値引 | 無視 | **処理しない！！** |
| 18 | 消費税 | - | - | 現金売上時に自動追加（商品コード='00000'） |

### 3.3 単位コード（在庫調整用）
| コード | 意味 | 集計先 |
|--------|------|--------|
| 01 | 在庫ロス | 在庫調整 |
| 02 | ギフト経費 | 加工 |
| 03 | 腐り | 在庫調整 |
| 04 | 振替 | 振替 |
| 05 | 加工費B | 加工 |
| 06 | 在庫調整 | 在庫調整 |

## 4. 計算ロジック

### 4.1 在庫評価方法
- **移動平均法**を採用
- 理由：扱い品目が果物、野菜、鮮魚のため日々仕入単価が変動

### 4.2 粗利計算（2段階処理）

#### 処理2-4: 在庫単価計算（0除算チェック必須）
```
①前日在庫数＋当日入荷数＝（仮）在庫数
②前日在庫金額＋当日入荷金額＝（仮）在庫金額
③（仮）在庫金額÷（仮）在庫数＝当日在庫単価【小数点第5位四捨五入】
④前日在庫数＋当日入荷数－当日出荷数＝当日在庫数
⑤当日在庫数×当日在庫単価＝当日在庫金額【小数点第5位四捨五入】

粗利益修正：
当日粗利益－当日在庫調整金額－当日加工費＝当日粗利益
```

#### 処理2-5: 売上伝票1行ごとの粗利計算
1. 売上伝票を読込（処理2-2と同じ条件）
2. 単価が0の場合：`金額÷数量＝粗利計算単価`（小数第5位四捨五入）
3. **粗利益計算**：
   ```
   (売上伝票の単価 - CP在庫Mの当日在庫単価) × 売上伝票の数量 = 売上伝票1行の粗利益
   ```
4. 売上伝票に粗利益を書込み、CP在庫Mの当日粗利益に集計
5. 歩引き金額をCP在庫Mに集計（売上伝票の粗利益には含めない）

### 4.3 歩引き金計算
- **計算式**: 売上金額 × 歩引き率 = 歩引き金額
- **歩引き率**: 得意先マスタの汎用数値1（小数第2位まで）
- **例**: 20,000円 × 11.55% ÷ 100 = 2,310円

### 4.4 奨励金計算
- **対象**: 仕入先分類1が「01」の仕入伝票
- **計算式**: 仕入金額 × 1% = 奨励金額

## 5. 特殊処理

### 5.1 除外データ条件
| 条件 | アンマッチ・商品勘定 | 商品日報・在庫表 |
|------|---------------------|------------------|
| 荷印名先頭4文字が「EXIT」「exit」 | 処理しない | 使用する |
| 荷印コードが「9900」「9910」「1353」 | 処理しない | 使用する |

### 5.2 商品分類変更ルール
| 荷印名先頭4文字 | 変更後の商品分類1 |
|-----------------|-------------------|
| 9aaa | 8 |
| 1aaa | 6 |
| 0999 | 6 |

## 6. パフォーマンス要件

### 6.1 現在の処理時間と目標
| 処理内容 | 現在 | 目標 | 備考 |
|----------|------|------|------|
| データ取込 | 5分 | - | |
| 在庫計算 | 15分 | 短縮要 | 1日に何度も実行 |
| 帳票出力 | 10分 | - | |
| アンマッチ処理 | 12分 | 短縮要 | |
| **合計** | **42分** | **大幅短縮** | |

### 6.2 データ量
- **売上伝票**: 500～1,200件/日（年間280,000件）
- **仕入伝票**: 200～400件/日（年間120,000件）
- **在庫調整**: 50～150件/日
- **在庫マスタ**: 月1,500件（年間約10,000件）

## 7. システム環境

### 7.1 サーバー環境
- **機種**: 富士通 PRIMERGY
- **CPU**: Xeon E-2434（4コア）
- **メモリ**: 32GB（16GB×2）
- **ストレージ**: SSD 960GB
- **OS**: Windows Server 2022 Standard
- **SQL Server**: 
  - 販売大臣用: 2022 Standard
  - 在庫管理用: 2022 Express（共存）

### 7.2 クライアント環境
- **PC**: 富士通またはNEC
- **OS**: Windows 11 Professional
- **メモリ**: 16GB
- **ストレージ**: SSD 500GB

### 7.3 帳票出力
- **PDF出力**（A3用紙に印刷）
- **Excel出力**も必要
  - 粗利益付き売上伝票データの年間累積
  - 在庫マスタデータの活用

## 8. 重要な課題：誤操作防止

### 8.1 問題点
日次終了処理で誤った日付のデータを処理してしまうリスク：
- 商品日報作成後に翌日分を誤ってエクスポート
- そのまま日次終了処理を実行すると翌日分で更新される

### 8.2 対策案
1. **データセット管理**
   - 最終商品日報のデータに日時の印を付ける
   - 日次終了処理は最終商品日報と同じデータセットのみ処理
   
2. **処理履歴管理**
   - 売上伝票、仕入伝票、在庫調整のデータセットを記録
   - 処理前に整合性チェック

## 9. 追記事項

### 9.1 消費税の扱い
- 現金売上（伝票種=52）入力時に自動追加
- 明細種=18（伝票単位消費税）
- 商品コード='00000'

### 9.2 値引の扱い
| 種類 | 説明 | 商品コード | 在庫管理での扱い |
|------|------|------------|------------------|
| 単品値引（明細種=3） | 明細行で入力 | あり | 取り込む |
| 値引（明細種=4） | 明細行で入力 | なし | **取り込まない** |

## 10. 実装上の注意点

1. **0除算対策**を必ず実装
2. **小数点処理**に注意（第5位四捨五入）
3. **除外条件**は処理によって異なる
4. **誤操作防止**機能の実装が必須
5. **パフォーマンス**改善が重要課題