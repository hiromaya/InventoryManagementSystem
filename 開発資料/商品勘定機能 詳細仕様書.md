# 商品勘定機能 詳細仕様書

**バージョン**: 2.0  
**最終更新日**: 2025年9月10日
**対象システム**: 在庫管理システム

## 1. 機能概要

### 1.1 目的
商品勘定は、商品別・荷印別の在庫収支を日次で管理し、移動平均法による在庫評価と粗利益計算を行う中核帳票です。長期在庫の把握と適正な在庫管理を支援します。

### 1.2 主要機能
- 商品別の入出庫明細表示
- 移動平均法による在庫単価計算
- 2段階粗利益計算（明細別・集計）
- 前残（繰越在庫）の管理
- 最終入荷日による長期在庫識別

## 2. 帳票レイアウト

### 2.1 用紙設定
```
用紙サイズ: A3横向き（420mm × 297mm）
余白: 上下左右 10mm
フォント: ＭＳ ゴシック
ページあたり最大行数: 35行
```

### 2.2 ヘッダー構成
```
作成日：YYYY年MM月DD日 HH時MM分SS秒    ※ YYYY年MM月DD日 商品勘定 ※    頁数
担当者：[担当者コード] [担当者名]
```

### 2.3 明細列構成
| 列名 | 幅(mm) | 内容 | 表示形式 |
|------|--------|------|----------|
| 商品名 | 24 | 商品名称 | 最大20文字 |
| 荷印CD | 14 | 荷印コード | 4桁 |
| 荷印名 | 25 | 荷印名称 | 最大20文字 |
| 手入力 | 15 | 手入力荷印 | 8文字固定 |
| 等級 | 12 | 等級名 | 3桁コード+名称 |
| 階級 | 12 | 階級名 | 3桁コード+名称 |
| 伝票NO | 14 | 伝票番号 | 10桁 |
| 区分 | 8 | 取引区分 | 下記参照 |
| 月日 | 10 | 取引日/前残日 | MM/DD |
| 仕入数量 | 18 | 仕入数量 | #,##0.00 |
| 売上数量 | 18 | 売上数量 | #,##0.00 |
| 残数量 | 18 | 在庫残高 | #,##0.00 |
| 単価 | 18 | 取引単価 | #,##0 |
| 金額 | 20 | 取引金額 | #,##0（▲表示） |
| 粗利益 | 18 | 粗利益額 | #,##0（▲表示） |
| 取引先名 | 30 | 得意先/仕入先 | 最大25文字 |

## 3. データ処理仕様

### 3.1 区分表示ルール
| 伝票区分/条件 | 表示名 | 説明 |
|---------------|--------|------|
| RecordType='Previous' | 前残 | 前日繰越在庫 |
| 11 | 掛仕 | 掛仕入 |
| 12 | 現仕 | 現金仕入 |
| 51 | 掛売 | 掛売上 |
| 52 | 現売 | 現金売上 |
| 71 | 調整 | 在庫調整 |
| 単位コード=01 | ロス | ロス処理 |
| 単位コード=03 | 腐り | 腐敗処理 |
| 単位コード=02,05 | 加工 | 加工費 |
| 単位コード=04 | 振替 | 振替処理 |
| 単位コード=06 | 調整 | 数量調整 |

### 3.2 前残明細の表示
```
【定義】
前残 = 処理日時点で在庫として残っている過去の入荷分

【表示内容】
- 区分: "前残"
- 月日: 最終入荷日（MM/DD形式）
- 残数量: 前日繰越数量
- 単価: 前日在庫単価
- 金額: 数量×単価
- 粗利益: 空欄（前残は粗利計算対象外）

【データ取得元】
InventoryCarryoverMaster（移行用在庫マスタ）から全期間遡って取得
```

### 3.3 最終入荷日の定義
```
【パターンB：最後に在庫が増加した日】

更新対象の取引：
✓ 仕入（伝票区分11,12）
✓ 振替入庫（単位コード04で数量>0）
✓ 在庫調整増（伝票区分71で数量>0、単位コード1,3,6）
✓ ロス戻し（単位コード01で数量>0）
✓ 腐り戻し（単位コード03で数量>0）

更新しない取引：
✗ 売上返品（伝票区分51,52でDetailType=2）
✗ 経費・加工費（単位コード02,05）
✗ 通常の売上・出庫
```

## 4. 在庫単価計算（移動平均法）

### 4.1 計算式
```csharp
// 1. 仮在庫数 = 前日在庫数 + 当日入荷数
仮在庫数 = 前日在庫数 + 当日入荷数

// 2. 仮在庫金額 = 前日在庫金額 + 当日入荷金額
仮在庫金額 = 前日在庫金額 + 当日入荷金額

// 3. 当日在庫単価（0除算対策必須）
if (仮在庫数 != 0) {
    当日在庫単価 = Round(仮在庫金額 / 仮在庫数, 4)
} else {
    当日在庫単価 = 前日在庫単価
}

// 4. 当日在庫数 = 前日在庫数 + 当日入荷数 - 当日出荷数
当日在庫数 = 前日在庫数 + 当日入荷数 - 当日出荷数

// 5. 当日在庫金額 = 当日在庫数 × 当日在庫単価
当日在庫金額 = Round(当日在庫数 × 当日在庫単価, 0)
```

### 4.2 入荷対象
- 仕入（全数量）
- 在庫調整（単位コード1,3,4,6で数量>0）
- 振替入庫（単位コード4で数量>0）
- **除外**: 経費・加工費（単位コード2,5）

## 5. 粗利益計算（2段階処理）

### 5.1 第1段階：明細行の粗利益
```
【売上の粗利益】
粗利益 = (売上単価 - 在庫単価) × 数量

【調整系の粗利益】
- ロス・腐り：金額をマイナス表示
- 振替：空欄（粗利に影響なし）
- 加工費：金額をマイナス表示
```

### 5.2 第2段階：集計行の粗利益
```
集計粗利益 = Σ売上粗利益 - Σロス金額 - Σ加工費
```

## 6. 集計行の表示

### 6.1 表示項目
```
【前日残】【仕入計】【売上計】【当日残】【在庫単価】【在庫金額】【粗利益】【粗利率】
```

### 6.2 粗利率計算
```
粗利率 = (粗利益 ÷ 売上金額) × 100
※売上金額0の場合："****"表示
※小数第2位まで表示（XX.XX%）
```

## 7. データソース構成

### 7.1 CP在庫マスタ（CpInventoryMaster）
- 役割：当日の在庫計算用ワークスペース
- 保持期間：日次処理中のみ（処理後削除）
- 主要項目：5項目キー、当日在庫数量・単価・金額

### 7.2 移行用在庫マスタ（InventoryCarryoverMaster）
- 役割：前残情報の永続保存
- 保持期間：永続（DataSetId管理）
- 主要項目：5項目キー、繰越数量・金額、最終入荷日

### 7.3 5項目複合キー
```
1. ProductCode（商品コード）：5桁、0埋め
2. GradeCode（等級コード）：3桁、0埋め
3. ClassCode（階級コード）：3桁、0埋め
4. ShippingMarkCode（荷印コード）：4桁、0埋め
5. ManualShippingMark（手入力荷印）：8文字、右詰め空白埋め
```

## 8. ソート順序

### 8.1 明細のソート
1. 商品分類1（担当者）
2. 商品コード
3. 荷印コード
4. 手入力荷印
5. 等級コード
6. 階級コード
7. 取引日付
8. 伝票番号

### 8.2 改ページ条件
- 商品分類1（担当者）が変更
- 1ページ35行超過
- 商品ごとに小計表示

## 9. エラー処理・制約事項

### 9.1 前提条件
- CP在庫マスタが作成済み
- アンマッチリストで異常なし
- 売上・仕入伝票が取込済み

### 9.2 エラー処理
- 0除算：前回値を使用
- NULL値：0として処理
- マスタ未登録：警告ログ出力

### 9.3 パフォーマンス
- バッチサイズ：1000件単位
- タイムアウト：300秒
- 最大処理件数：100,000件/日

## 10. 処理フロー

```
1. 初期化
   ├─ パラメータ検証
   └─ CP在庫マスタ確認

2. データ取得
   ├─ 移行用在庫マスタから前残取得
   ├─ 売上伝票データ取得
   ├─ 仕入伝票データ取得
   └─ 在庫調整データ取得

3. 明細生成
   ├─ 前残明細作成
   ├─ 取引明細作成
   └─ ソート処理

4. 集計計算
   ├─ 商品別集計
   ├─ 粗利益計算
   └─ 在庫評価

5. 帳票出力
   ├─ PDF生成
   └─ ファイル保存
```

## 11. 関連機能

- **日次終了処理**：CP在庫→移行用在庫マスタへ転記
- **在庫表**：最終入荷日を表示
- **商品日報**：日次の入出庫集計

## 12. 変更履歴

| 日付 | バージョン | 内容 |
|------|------------|------|
| 2025-01 | 2.0 | 移行用在庫マスタ追加、最終入荷日実装 |
| 2024-12 | 1.0 | 初版作成 |

---

**注記**：本仕様書は在庫管理システムの商品勘定機能の技術仕様を定義したものです。実装時は本仕様書に準拠し、不明点は都度確認してください。