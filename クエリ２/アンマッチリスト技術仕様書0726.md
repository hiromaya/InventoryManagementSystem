申し訳ございません。実際のテーブル構造を確認して、正しい技術仕様書を作成します。

# アンマッチリスト技術仕様書（最新版・データベース確認済み）

## 1. 概要

### 1.1 目的
アンマッチリストは「明かな伝票入力ミスを検索してリストにする」機能です。

### 1.2 重要な仕様変更（2025年7月）
クライアントから以下の重要な仕様変更がありました：
- **マイナス在庫はOK**（アンマッチリストに出さない）
- **在庫マスタにKeyが存在しない場合のみエラー**とする
- 同日売上・仕入相殺は正常な業務フローとして扱う

## 2. 処理フロー

### 2.1 処理順序
```
1. 処理1-1: CP在庫マスタ作成（前日在庫をコピー）
2. 処理1-2前: 当日エリアクリア
   - CP在庫Mの当日エリアの数値をクリア
   - 当日発生フラグ（DailyFlag）に'9'をセット
3. 処理1-2: 当日データ集計
   - 仕入伝票（数量＞0）のみCP在庫Mに集計
   - 在庫調整（数量＞0）のみCP在庫Mに集計
   - 当日発生フラグ（DailyFlag）に'0'をセット
4. 処理1-6: アンマッチチェック実行
   - 売上伝票（数量＜0）とCP在庫Mをマッチング
```

### 2.2 重要な処理仕様
- **入荷データのみCP在庫Mに集計**（仕入・在庫調整の数量＞0）
- **出荷データ（売上）はCP在庫Mに集計しない**
- 売上伝票処理時にCP在庫MにKeyがなければ「在庫マスタ無」エラー

## 3. データベース構造（実テーブル基準）

### 3.1 CP在庫マスタ（CpInventoryMaster）のキー構造
```sql
-- CP在庫マスタの主キー（5項目複合キー + DataSetId）
-- PRIMARY KEY:
-- ProductCode (NVARCHAR(15))
-- GradeCode (NVARCHAR(15))
-- ClassCode (NVARCHAR(15))
-- ShippingMarkCode (NVARCHAR(15))
-- ShippingMarkName (NVARCHAR(50))
-- DataSetId (NVARCHAR(100))
```

### 3.2 CP在庫マスタの主要カラム
```sql
-- 実際に存在するカラムの確認
SELECT TOP 1
    ProductCode,                         -- 商品コード
    GradeCode,                          -- 等級コード
    ClassCode,                          -- 階級コード
    ShippingMarkCode,                   -- 荷印コード
    ShippingMarkName,                   -- 荷印名
    JobDate,                            -- ジョブデート
    DailyFlag,                          -- 当日発生フラグ ('9' or '0')
    PreviousDayStock,                   -- 前日在庫数量
    PreviousDayStockAmount,             -- 前日在庫金額
    DailyStock,                         -- 当日在庫数量
    DailyStockAmount,                   -- 当日在庫金額
    DailySalesQuantity,                 -- 当日売上数量
    DailySalesAmount,                   -- 当日売上金額
    DailyPurchaseQuantity,              -- 当日仕入数量
    DailyPurchaseAmount,                -- 当日仕入金額
    DailyInventoryAdjustmentQuantity,   -- 当日在庫調整数量
    DailyInventoryAdjustmentAmount      -- 当日在庫調整金額
FROM CpInventoryMaster;
```

## 4. アンマッチ判定条件（実行可能SQL）

### 4.1 売上伝票のアンマッチ条件（在庫マスタ無エラーのみ）
```sql
-- パラメータ宣言
DECLARE @JobDate DATE = '2025-06-02';

-- 在庫マスタ無エラーの売上伝票を抽出
SELECT 
    sv.VoucherNumber,
    sv.ProductCode,
    sv.ProductName,
    sv.GradeCode,
    sv.ClassCode,
    sv.ShippingMarkCode,
    sv.ShippingMarkName,
    sv.Quantity,
    sv.UnitPrice,
    sv.Amount,
    '在庫マスタ無' AS UnmatchType
FROM SalesVouchers sv
WHERE sv.JobDate = @JobDate
  AND sv.VoucherType IN ('51', '52')  -- 掛売上、現金売上
  AND sv.DetailType = '1'              -- 売上（返品は'2'）
  AND sv.Quantity <> 0                 -- 数量0は除外
  AND sv.ProductCode <> '00000'        -- オール0は除外
  AND NOT EXISTS (
    SELECT 1 FROM CpInventoryMaster cp
    WHERE cp.ProductCode = sv.ProductCode
      AND cp.GradeCode = sv.GradeCode
      AND cp.ClassCode = sv.ClassCode
      AND cp.ShippingMarkCode = sv.ShippingMarkCode
      AND cp.ShippingMarkName = sv.ShippingMarkName
      AND cp.JobDate = @JobDate
  );
```

### 4.2 仕入伝票のアンマッチ条件（在庫マスタ無エラーのみ）
```sql
-- パラメータ宣言
DECLARE @JobDate DATE = '2025-06-02';

-- 在庫マスタ無エラーの仕入伝票を抽出
SELECT 
    pv.VoucherNumber,
    pv.ProductCode,
    pv.GradeCode,
    pv.ClassCode,
    pv.ShippingMarkCode,
    pv.ShippingMarkName,
    pv.Quantity,
    pv.UnitPrice,
    pv.Amount,
    '在庫マスタ無' AS UnmatchType
FROM PurchaseVouchers pv
WHERE pv.JobDate = @JobDate
  AND pv.VoucherType IN ('11', '12')  -- 掛仕入、現金仕入
  AND pv.DetailType = '1'              -- 仕入（返品は'2'）
  AND pv.Quantity <> 0                 -- 数量0は除外
  AND pv.ProductCode <> '00000'        -- オール0は除外
  AND NOT EXISTS (
    SELECT 1 FROM CpInventoryMaster cp
    WHERE cp.ProductCode = pv.ProductCode
      AND cp.GradeCode = pv.GradeCode
      AND cp.ClassCode = pv.ClassCode
      AND cp.ShippingMarkCode = pv.ShippingMarkCode
      AND cp.ShippingMarkName = pv.ShippingMarkName
      AND cp.JobDate = @JobDate
  );
```

### 4.3 在庫調整のアンマッチ条件（在庫マスタ無エラーのみ）
```sql
-- パラメータ宣言
DECLARE @JobDate DATE = '2025-06-02';

-- 在庫マスタ無エラーの在庫調整を抽出（マイナス調整のみ）
SELECT 
    ia.VoucherNumber,
    ia.ProductCode,
    ia.GradeCode,
    ia.ClassCode,
    ia.ShippingMarkCode,
    ia.ShippingMarkName,
    ia.Quantity,
    ia.UnitPrice,
    ia.Amount,
    '在庫マスタ無' AS UnmatchType
FROM InventoryAdjustments ia
WHERE ia.JobDate = @JobDate
  AND ia.VoucherType IN ('71', '72')   -- 受注伝票を代用
  AND ia.DetailType = '1'               -- 売上を代用
  AND ia.Quantity < 0                   -- マイナス調整のみ
  -- AND ia.CategoryCode NOT IN (2, 5)  -- 経費(02)、加工(05)は除外（UnitCodeカラムがないため、CategoryCodeで判定）
  AND ia.ProductCode <> '00000'         -- オール0は除外
  AND NOT EXISTS (
    SELECT 1 FROM CpInventoryMaster cp
    WHERE cp.ProductCode = ia.ProductCode
      AND cp.GradeCode = ia.GradeCode
      AND cp.ClassCode = ia.ClassCode
      AND cp.ShippingMarkCode = ia.ShippingMarkCode
      AND cp.ShippingMarkName = ia.ShippingMarkName
      AND cp.JobDate = @JobDate
  );
```

## 5. CP在庫マスタ操作SQL

### 5.1 当日エリアクリア
```sql
-- パラメータ宣言
DECLARE @JobDate DATE = '2025-06-02';

-- 当日エリアクリアと当日発生フラグ='9'セット
UPDATE CpInventoryMaster
SET DailySalesQuantity = 0,
    DailySalesAmount = 0,
    DailySalesReturnQuantity = 0,
    DailySalesReturnAmount = 0,
    DailyPurchaseQuantity = 0,
    DailyPurchaseAmount = 0,
    DailyPurchaseReturnQuantity = 0,
    DailyPurchaseReturnAmount = 0,
    DailyInventoryAdjustmentQuantity = 0,
    DailyInventoryAdjustmentAmount = 0,
    DailyProcessingQuantity = 0,
    DailyProcessingAmount = 0,
    DailyTransferQuantity = 0,
    DailyTransferAmount = 0,
    DailyGrossProfit = 0,
    DailyFlag = '9',
    UpdatedDate = GETDATE()
WHERE JobDate = @JobDate;
```

### 5.2 仕入データ集計（数量＞0のみ）
```sql
-- パラメータ宣言
DECLARE @JobDate DATE = '2025-06-02';

-- 仕入伝票から集計（入荷データのみ）
UPDATE cp
SET cp.DailyPurchaseQuantity = ISNULL(pv.TotalQuantity, 0),
    cp.DailyPurchaseAmount = ISNULL(pv.TotalAmount, 0),
    cp.DailyFlag = '0',
    cp.UpdatedDate = GETDATE()
FROM CpInventoryMaster cp
LEFT JOIN (
    SELECT 
        ProductCode,
        GradeCode,
        ClassCode,
        ShippingMarkCode,
        ShippingMarkName,
        SUM(Quantity) AS TotalQuantity,
        SUM(Amount) AS TotalAmount
    FROM PurchaseVouchers
    WHERE JobDate = @JobDate
      AND VoucherType IN ('11', '12')
      AND DetailType = '1'
      AND Quantity > 0  -- 入荷データのみ
      AND ProductCode <> '00000'
    GROUP BY ProductCode, GradeCode, ClassCode, ShippingMarkCode, ShippingMarkName
) pv ON cp.ProductCode = pv.ProductCode
    AND cp.GradeCode = pv.GradeCode
    AND cp.ClassCode = pv.ClassCode
    AND cp.ShippingMarkCode = pv.ShippingMarkCode
    AND cp.ShippingMarkName = pv.ShippingMarkName
WHERE cp.JobDate = @JobDate;
```

## 6. 統合アンマッチリスト作成

### 6.1 全アンマッチデータ抽出（実行用）
```sql
-- パラメータ宣言
DECLARE @JobDate DATE = '2025-06-02';

-- 一時テーブル作成
IF OBJECT_ID('tempdb..#UnmatchList') IS NOT NULL
    DROP TABLE #UnmatchList;

CREATE TABLE #UnmatchList (
    VoucherType NVARCHAR(10),
    VoucherNumber NVARCHAR(20),
    ProductCode NVARCHAR(15),
    ProductName NVARCHAR(100),
    GradeCode NVARCHAR(15),
    GradeName NVARCHAR(50),
    ClassCode NVARCHAR(15),
    ClassName NVARCHAR(50),
    ShippingMarkCode NVARCHAR(15),
    ShippingMarkName NVARCHAR(50),
    Quantity DECIMAL(18,4),
    UnitPrice DECIMAL(18,4),
    Amount DECIMAL(18,4),
    UnmatchType NVARCHAR(20)
);

-- 売上伝票のアンマッチ
INSERT INTO #UnmatchList
SELECT 
    '売上' AS VoucherType,
    sv.VoucherNumber,
    sv.ProductCode,
    sv.ProductName,
    sv.GradeCode,
    ISNULL(gm.GradeName, '') AS GradeName,
    sv.ClassCode,
    ISNULL(cm.ClassName, '') AS ClassName,
    sv.ShippingMarkCode,
    sv.ShippingMarkName,
    sv.Quantity,
    sv.UnitPrice,
    sv.Amount,
    '在庫マスタ無' AS UnmatchType
FROM SalesVouchers sv
LEFT JOIN GradeMaster gm ON sv.GradeCode = gm.GradeCode
LEFT JOIN ClassMaster cm ON sv.ClassCode = cm.ClassCode
WHERE sv.JobDate = @JobDate
  AND sv.VoucherType IN ('51', '52')
  AND sv.DetailType = '1'
  AND sv.Quantity <> 0
  AND sv.ProductCode <> '00000'
  AND NOT EXISTS (
    SELECT 1 FROM CpInventoryMaster cp
    WHERE cp.ProductCode = sv.ProductCode
      AND cp.GradeCode = sv.GradeCode
      AND cp.ClassCode = sv.ClassCode
      AND cp.ShippingMarkCode = sv.ShippingMarkCode
      AND cp.ShippingMarkName = sv.ShippingMarkName
      AND cp.JobDate = @JobDate
  );

-- 結果表示
SELECT * FROM #UnmatchList
ORDER BY VoucherType, VoucherNumber;

-- 件数表示
SELECT 
    VoucherType,
    COUNT(*) AS UnmatchCount
FROM #UnmatchList
GROUP BY VoucherType;

-- 総件数
SELECT COUNT(*) AS TotalUnmatchCount FROM #UnmatchList;
```

## 7. データ確認用SQL

### 7.1 CP在庫マスタの状態確認
```sql
-- 特定日のCP在庫マスタ件数確認
DECLARE @JobDate DATE = '2025-06-02';

SELECT 
    COUNT(*) AS TotalCount,
    COUNT(DISTINCT ProductCode) AS UniqueProducts,
    COUNT(CASE WHEN DailyFlag = '9' THEN 1 END) AS Flag9Count,
    COUNT(CASE WHEN DailyFlag = '0' THEN 1 END) AS Flag0Count
FROM CpInventoryMaster
WHERE JobDate = @JobDate;
```

### 7.2 売上伝票データ確認
```sql
-- 特定日の売上伝票確認
DECLARE @JobDate DATE = '2025-06-02';

SELECT TOP 10
    VoucherNumber,
    VoucherType,
    DetailType,
    ProductCode,
    ProductName,
    GradeCode,
    ClassCode,
    ShippingMarkCode,
    ShippingMarkName,
    Quantity
FROM SalesVouchers
WHERE JobDate = @JobDate
  AND VoucherType IN ('51', '52')
  AND DetailType = '1'
  AND Quantity <> 0
  AND ProductCode <> '00000'
ORDER BY VoucherNumber;
```

### 7.3 テーブル構造確認
```sql
-- CpInventoryMasterのカラム一覧
SELECT 
    COLUMN_NAME,
    DATA_TYPE,
    CHARACTER_MAXIMUM_LENGTH,
    IS_NULLABLE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'CpInventoryMaster'
ORDER BY ORDINAL_POSITION;
```

## 8. 実装用ストアドプロシージャ

### 8.1 アンマッチリスト生成SP
```sql
CREATE OR ALTER PROCEDURE sp_GenerateUnmatchList
    @JobDate DATE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- 結果格納用テーブル変数
    DECLARE @UnmatchList TABLE (
        Id INT IDENTITY(1,1),
        VoucherType NVARCHAR(10),
        VoucherNumber NVARCHAR(20),
        ProductCode NVARCHAR(15),
        ProductName NVARCHAR(100),
        GradeCode NVARCHAR(15),
        GradeName NVARCHAR(50),
        ClassCode NVARCHAR(15),
        ClassName NVARCHAR(50),
        ShippingMarkCode NVARCHAR(15),
        ShippingMarkName NVARCHAR(50),
        Quantity DECIMAL(18,4),
        UnitPrice DECIMAL(18,4),
        Amount DECIMAL(18,4),
        UnmatchType NVARCHAR(20)
    );
    
    -- 売上伝票のアンマッチ（在庫マスタ無のみ）
    INSERT INTO @UnmatchList
    SELECT 
        '売上',
        sv.VoucherNumber,
        sv.ProductCode,
        sv.ProductName,
        sv.GradeCode,
        ISNULL(gm.GradeName, ''),
        sv.ClassCode,
        ISNULL(cm.ClassName, ''),
        sv.ShippingMarkCode,
        sv.ShippingMarkName,
        sv.Quantity,
        sv.UnitPrice,
        sv.Amount,
        '在庫マスタ無'
    FROM SalesVouchers sv
    LEFT JOIN GradeMaster gm ON sv.GradeCode = gm.GradeCode
    LEFT JOIN ClassMaster cm ON sv.ClassCode = cm.ClassCode
    WHERE sv.JobDate = @JobDate
      AND sv.VoucherType IN ('51', '52')
      AND sv.DetailType = '1'
      AND sv.Quantity <> 0
      AND sv.ProductCode <> '00000'
      AND NOT EXISTS (
        SELECT 1 FROM CpInventoryMaster cp
        WHERE cp.ProductCode = sv.ProductCode
          AND cp.GradeCode = sv.GradeCode
          AND cp.ClassCode = sv.ClassCode
          AND cp.ShippingMarkCode = sv.ShippingMarkCode
          AND cp.ShippingMarkName = sv.ShippingMarkName
          AND cp.JobDate = @JobDate
      );
    
    -- 結果を返す
    SELECT * FROM @UnmatchList
    ORDER BY VoucherType, VoucherNumber;
    
    -- 件数を返す
    SELECT COUNT(*) AS TotalUnmatchCount
    FROM @UnmatchList;
END;
```

## 9. 注意事項

### 9.1 データ型の確認
- ProductCode: NVARCHAR(15)
- GradeCode: NVARCHAR(15)
- ClassCode: NVARCHAR(15)
- ShippingMarkCode: NVARCHAR(15)
- ShippingMarkName: NVARCHAR(50)
- DailyFlag: NCHAR(1) -- '9' または '0'

### 9.2 インデックス作成（推奨）
```sql
-- CP在庫マスタ用インデックス
CREATE NONCLUSTERED INDEX IX_CpInventoryMaster_JobDate_Keys
ON CpInventoryMaster (
    JobDate,
    ProductCode,
    GradeCode,
    ClassCode,
    ShippingMarkCode,
    ShippingMarkName
)
INCLUDE (DailyFlag, PreviousDayStock, DailyStock);
```

---

**最終更新日**: 2025年7月26日  
**バージョン**: 3.0  
**注意**: 実際のテーブル構造に基づいて作成済み