# アンマッチリスト技術仕様書（2025年7月27日改訂版）

## 1. 概要

### 1.1 目的
アンマッチリストは「明らかな伝票入力ミスを検索してリストにする」機能です。

### 1.2 重要な仕様変更（2025年7月27日）
クライアントから以下の重要な仕様変更がありました：

**【アーキテクチャ変更】**
- UN在庫マスタ（アンマッチ専用）とCP在庫マスタ（帳票作成用）を分離
- import-folderコマンドからアンマッチチェック機能を分離
- アンマッチ0件確認後のみCP在庫マスタ作成を許可

**【処理仕様変更】**
- 在庫マスタにKeyが存在しない場合のみ「在庫マスタ無」エラー
- **マイナス在庫はOK**（アンマッチデータとしない）
- 入荷と出荷の概念を正しく反映した処理

## 2. コマンド体系と処理フロー

### 2.1 コマンド分離設計
```
【import-folderコマンド】
責務：伝票データの取り込みのみ
1. 伝票インポート（売上・仕入・在庫調整）
2. 在庫マスタ更新
※アンマッチチェックは行わない
※UN在庫マスタ・CP在庫マスタは作成しない

【unmatch-listコマンド】
責務：データ品質チェック
1. 既存UN在庫マスタの削除
2. UN在庫マスタ新規作成（在庫マスタから数量のみコピー）
3. アンマッチチェック実行
4. アンマッチリストPDF出力

【product-accountコマンド（商品勘定）】
責務：品質保証済みデータでの帳票作成
1. CP在庫マスタ作成（在庫マスタから全項目コピー）
2. 商品勘定作成
※アンマッチ0件が前提条件

【daily-closingコマンド】
責務：日次処理の完了
1. CP在庫マスタ削除
2. UN在庫マスタ削除
```

### 2.2 処理フロー図
```
伝票データ
    ↓
[import-folder] → 在庫マスタ更新
    ↓
[unmatch-list] → UN在庫マスタ作成 → アンマッチチェック
    ↓                                     ↓
    ↓                              エラーあり → 伝票修正して再度import-folder
    ↓                                     ↓
    ↓                              エラーなし（0件）
    ↓                                     ↓
[product-account] → CP在庫マスタ作成 → 商品勘定作成
    ↓
[その他帳票] → CP在庫マスタ使用
    ↓
[daily-closing] → UN/CP在庫マスタ削除
```

## 3. データベース構造

### 3.1 UN在庫マスタ（UnInventoryMaster）- 新規追加
```sql
-- アンマッチチェック専用の仮テーブル
CREATE TABLE UnInventoryMaster (
    ProductCode NVARCHAR(15) NOT NULL,      -- 商品コード
    GradeCode NVARCHAR(15) NOT NULL,        -- 等級コード
    ClassCode NVARCHAR(15) NOT NULL,        -- 階級コード
    ShippingMarkCode NVARCHAR(15) NOT NULL, -- 荷印コード
    ShippingMarkName NVARCHAR(50) NOT NULL, -- 荷印名
    DataSetId NVARCHAR(100) NOT NULL,       -- データセットID
    
    -- 数量のみ（単価・金額は不要）
    PreviousDayStock DECIMAL(18,4),         -- 前日在庫数量
    DailyStock DECIMAL(18,4),               -- 当日在庫数量
    DailyFlag CHAR(1),                      -- 当日発生フラグ
    
    CreatedDate DATETIME2,
    UpdatedDate DATETIME2,
    
    PRIMARY KEY (ProductCode, GradeCode, ClassCode, ShippingMarkCode, ShippingMarkName, DataSetId)
)
```

### 3.2 CP在庫マスタ（CpInventoryMaster）
```sql
-- 帳票作成用の本番テーブル（既存）
-- 数量、単価、金額、粗利益を含む完全なデータ
-- アンマッチ0件確認後のみ作成可能
```

### 3.3 売上伝票（SalesVouchers）
```sql
-- レコード数: 5,282件（テーブル20.json）
-- 主要カラム:
VoucherId         -- 伝票ID
VoucherType       -- 伝票種別（51:掛売上, 52:現金売上）
DetailType        -- 明細種別（1:売上, 2:返品, 3:単品値引）
VoucherNumber     -- 伝票番号
JobDate           -- ジョブデート（汎用日付2）
ProductCode       -- 商品コード
GradeCode         -- 等級コード
ClassCode         -- 階級コード
ShippingMarkCode  -- 荷印コード
ShippingMarkName  -- 荷印名
Quantity          -- 数量
UnitPrice         -- 単価
Amount            -- 金額
```

### 3.4 仕入伝票（PurchaseVouchers）
```sql
-- レコード数: 232件（テーブル19.json）
-- 主要カラム: 売上伝票と同様の構造
VoucherType       -- 伝票種別（11:掛仕入, 12:現金仕入）
DetailType        -- 明細種別（1:仕入, 2:返品, 3:単品値引）
```

### 3.5 在庫調整（InventoryAdjustments）
```sql
-- レコード数: 30件（テーブル21.json）
-- 主要カラム:
VoucherType       -- 伝票種別（71:受注掛売上代用, 72:受注現金売上代用）
DetailType        -- 明細種別（1のみ使用）
CategoryCode      -- 区分コード（2:ギフト経費, 5:加工費Bは除外）
```

## 4. アンマッチチェック処理詳細

### 4.1 処理順序（unmatch-listコマンド内）
```
1. 既存UN在庫マスタ削除
2. 処理1-1: UN在庫マスタ作成（在庫マスタから数量のみコピー）
3. 処理1-2前: 当日エリアクリア
   - UN在庫Mの当日エリアの数値をクリア
   - 当日発生フラグ（DailyFlag）に'9'をセット
4. 処理1-2: 当日データ集計（入荷データのみ）
   - 売上伝票：数量＜0（売上返品）をUN在庫Mに集計
   - 仕入伝票：数量＞0（通常仕入）をUN在庫Mに集計
   - 在庫調整：数量＞0（入荷調整）をUN在庫Mに集計
   - 当日発生フラグ（DailyFlag）に'0'をセット
5. 処理1-6: アンマッチチェック実行（出荷データをチェック）
   - 売上伝票：数量＞0（通常売上）とUN在庫Mをマッチング
   - 仕入伝票：数量＜0（仕入返品）とUN在庫Mをマッチング
   - 在庫調整：数量＜0（出荷調整）とUN在庫Mをマッチング
```

### 4.2 重要な処理仕様
- **入荷データのみUN在庫Mに集計**
  - 売上伝票：数量＜0のみ集計（売上返品＝入荷）
  - 仕入伝票：数量＞0のみ集計（通常仕入＝入荷）
  - 在庫調整：数量＞0のみ集計（入荷調整）
- **アンマッチチェックは出荷データのみ**
  - 売上伝票：数量＞0（通常売上＝出荷）
  - 仕入伝票：数量＜0（仕入返品＝出荷）
  - 在庫調整：数量＜0（出荷調整）
- **エラー判定**：UN在庫MにKeyがなければ「在庫マスタ無」エラーのみ

## 5. アンマッチ判定条件

### 5.1 売上伝票のアンマッチ条件
```sql
-- アンマッチチェック対象（出荷データ）
WHERE sv.JobDate = @JobDate
  AND sv.VoucherType IN ('51', '52')  -- 掛売上、現金売上
  AND sv.DetailType IN ('1', '2')     -- 売上、返品（単品値引は除外）
  AND sv.Quantity > 0                  -- 出荷（通常売上）のみ
  AND sv.ProductCode <> '00000'        -- オール0は除外

-- エラー判定
IF NOT EXISTS (UN在庫MにKeyが存在) THEN
    エラー: 「在庫マスタ無」
END IF
```

### 5.2 仕入伝票のアンマッチ条件
```sql
-- アンマッチチェック対象（出荷データ）
WHERE pv.JobDate = @JobDate
  AND pv.VoucherType IN ('11', '12')  -- 掛仕入、現金仕入
  AND pv.DetailType IN ('1', '2')     -- 仕入、返品（単品値引は除外）
  AND pv.Quantity < 0                  -- 出荷（仕入返品）のみ
  AND pv.ProductCode <> '00000'        -- オール0は除外

-- エラー判定
IF NOT EXISTS (UN在庫MにKeyが存在) THEN
    エラー: 「在庫マスタ無」
END IF
```

### 5.3 在庫調整のアンマッチ条件
```sql
-- アンマッチチェック対象（出荷データ）
WHERE ia.JobDate = @JobDate
  AND ia.VoucherType IN ('71', '72')   -- 受注伝票を代用
  AND ia.DetailType = '1'               -- 売上を代用
  AND ia.Quantity < 0                   -- 出荷（マイナス調整）のみ
  AND ia.CategoryCode NOT IN (2, 5)     -- 経費、加工費Bは除外
  AND ia.ProductCode <> '00000'         -- オール0は除外

-- エラー判定
IF NOT EXISTS (UN在庫MにKeyが存在) THEN
    エラー: 「在庫マスタ無」
END IF
```

## 6. 共通条件

### 6.1 除外条件（全伝票共通）
- 数量が0の行は処理しない
- 商品コード"00000"（消費税等）は除外

### 6.2 売上・仕入伝票の条件
- 明細種別：1（通常）、2（返品）のみ
- 明細種別3（単品値引）は除外
- 伝票区分：
  - 売上伝票：'51'（掛売上）、'52'（現金売上）
  - 仕入伝票：'11'（掛仕入）、'12'（現金仕入）

### 6.3 在庫調整の条件
- 明細種別：1のみ処理（受注伝票を代用）
- 区分コード2（ギフト経費）、5（加工費B）は除外
- 伝票区分：'71'、'72'

## 7. エラー判定

### 7.1 エラー種別
- **E01**：在庫マスタ無（UN在庫マスタにKeyが存在しない）

### 7.2 エラー判定ルール
- UN在庫マスタに5項目キーが存在しない場合のみエラー
- **マイナス在庫はOK**（エラーとしない）
- 在庫数量チェックは行わない

## 8. 品質保証の考え方

### 8.1 UN在庫マスタとCP在庫マスタの役割
- **UN在庫マスタ**: 品質チェック用の仮テーブル
  - アンマッチチェックのためだけに使用
  - エラーがある限り何度でも作り直し
  - 数量のみを保持（単価・金額は不要）

- **CP在庫マスタ**: 品質保証済みの本番テーブル
  - アンマッチ0件が確認された後のみ作成可能
  - 全ての帳票作成で使用
  - 在庫マスタから作成（UN在庫マスタは使用しない）

### 8.2 品質保証フロー
```
伝票データ（品質未保証）
    ↓
UN在庫マスタでチェック
    ↓
アンマッチ0件（品質保証完了）
    ↓
CP在庫マスタ作成許可
    ↓
帳票作成可能
```

## 9. 運用フロー

### 9.1 日次運用手順
```bash
# 1. データインポート
dotnet run import-folder D:\InventoryImport\DeptA

# 2. アンマッチチェック（UN在庫マスタ作成・チェック実行）
dotnet run unmatch-list [YYYY-MM-DD]

# 3. アンマッチがある場合
# - アンマッチリストPDFを確認
# - 伝票データを修正
# - 手順1から再実行

# 4. アンマッチ0件確認後、商品勘定作成（CP在庫マスタ作成）
dotnet run product-account [YYYY-MM-DD]

# 5. その他の帳票作成
dotnet run daily-report [YYYY-MM-DD]
dotnet run inventory-list [YYYY-MM-DD]

# 6. 日次終了処理（UN/CP在庫マスタ削除）
dotnet run daily-closing [YYYY-MM-DD]
```

### 9.2 エラー時の対応
- アンマッチエラーが検出された場合、必ず伝票データを修正してimport-folderから再実行
- UN在庫マスタは自動的に再作成されるため、手動削除は不要

## 10. 更新履歴

| 日付 | バージョン | 更新内容 |
|------|------------|----------|
| 2025/07/27 | 4.0 | アーキテクチャ変更（UN/CP在庫マスタ分離、コマンド責務明確化） |
| 2025/07/27 | 3.0 | クライアント仕様訂正対応（入荷・出荷概念の明確化、数量条件修正） |
| 2025/07/26 | 2.0 | マイナス在庫許容、在庫0チェック削除 |
| 2025/07/20 | 1.0 | 初版作成 |

## 11. 補足事項

### 11.1 設計思想
- **責務の分離**: 各コマンドは単一の責務を持つ
- **エラー検出の容易性**: アンマッチチェックを独立させることで、大量の伝票ログに埋もれずエラーを発見可能
- **品質ゲート**: CP在庫マスタは品質保証済みデータのみで構成

### 11.2 入荷と出荷の概念
- **入荷**：在庫が増える処理（売上返品、通常仕入、在庫調整プラス）
- **出荷**：在庫が減る処理（通常売上、仕入返品、在庫調整マイナス）

### 11.3 マイナス在庫の扱い
- 仕入伝票遅れ等で月に数回発生する正常な業務フロー
- マイナス在庫でも商品勘定、商品日報、在庫表、日次終了処理はOK

---
**最終更新**: 2025年7月27日  
**作成者**: Claude  
**承認**: システム担当者