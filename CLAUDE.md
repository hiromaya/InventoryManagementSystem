# 在庫管理システム開発ガイド

## 📋 プロジェクト概要

食品販売業向けの在庫管理システム。販売大臣AXの外付けシステムとして、日々の在庫処理時間を3時間55分から30分に短縮することが目標。

## 🛠️ 技術スタック

- **言語**: C# (.NET 8.0)
- **データベース**: SQL Server 2022 Express
- **帳票**: QuestPDF
- **データアクセス**: Dapper
- **CSV処理**: CsvHelper
- **ログ**: Serilog
- **開発環境**: Cursor + Claude Code

## ⚡ 最重要仕様

### 1. 在庫マスタのキー構造（5項目複合キー）
```csharp
public class InventoryKey
{
    public string ProductCode { get; set; }      // 商品コード (15桁)
    public string GradeCode { get; set; }        // 等級コード (15桁)
    public string ClassCode { get; set; }        // 階級コード (15桁)
    public string ShippingMarkCode { get; set; } // 荷印コード (15桁)
    public string ShippingMarkName { get; set; } // 荷印名 (50桁)
}
```

### 2. 日付管理
- **必ず汎用日付2（ジョブデート）を使用**
- 伝票日付ではなく、実際の処理日で管理

### 3. 処理の基本フロー
1. 各処理で**毎回新規にCP在庫Mを作成**
2. 当日エリアクリア → 当日発生フラグ='9'
3. データ集計 → 当日発生フラグ='0'
4. 在庫計算・粗利計算

### 4. 粗利計算（2段階）
```csharp
// 第1段階：売上伝票1行ごと
粗利益 = (売上単価 - 在庫単価) × 数量

// 第2段階：調整
最終粗利益 = 当日粗利益 - 当日在庫調整金額 - 当日加工費
```

## 📐 設計方針

### エラーハンドリング
- **0除算対策を必ず実装**
- すべての計算処理で分母チェック
- 例外時は適切なデフォルト値またはエラー処理

### パフォーマンス
- バッチ処理は1000件単位
- 適切なインデックス設計
- 大量データの一括読み込みは避ける

### 誤操作防止
- データセットID管理の実装
- 処理履歴の記録
- ロールバック機能の実装

## 💻 コーディング規約

### 命名規則
```csharp
// クラス: PascalCase
public class InventoryMaster { }

// メソッド: PascalCase
public void CalculateGrossProfit() { }

// プライベートフィールド: _camelCase
private readonly IInventoryRepository _inventoryRepository;

// ローカル変数: camelCase
var dailyStock = 0;
```

### データベースアクセス
```csharp
// Dapper使用、using文で確実にリソース解放
using var connection = new SqlConnection(connectionString);
var result = await connection.QueryAsync<InventoryMaster>(sql, parameters);
```

## 🚫 除外データ条件

### アンマッチ・商品勘定でのみ除外
- 荷印名の先頭4文字が「EXIT」「exit」
- 荷印コードが「9900」「9910」「1353」

※商品日報・在庫表では使用する

## 🔄 特殊処理ルール

### 商品分類変更
- 荷印名先頭「9aaa」→ 商品分類1='8'
- 荷印名先頭「1aaa」→ 商品分類1='6'
- 荷印名先頭「0999」→ 商品分類1='6'

## 📁 フォルダ構成

```
D:\InventoryImport\
└── User01\（部門別）
    ├── Import\     # CSV取込先
    ├── Processed\  # 処理済み
    └── Error\      # エラー
```

## 🎯 パフォーマンス目標

| 処理           | 現状     | 目標     |
|--------------- |--------- |--------- |
| アンマッチ処理 | 12分     | 3分      |
| 在庫計算       | 15分     | 5分      |
| 帳票出力       | 10分     | 5分      |
| **合計**       | **42分** | **15分** |

## 📊 データ量の目安

- 売上伝票: 500-1,200件/日（年間28万件）
- 仕入伝票: 200-400件/日（年間12万件）
- 在庫マスタ: 年間約10,000件


# 在庫管理システム帳票仕様書

## 1. 商品日報

### 1.1 概要
- **目的**: 日次・月次の売上と粗利益を商品別に集計・分析
- **データソース**: CP在庫M（在庫マスタ）
- **出力形式**: A4横向き

### 1.2 レイアウト構造

```
※　202Y年99月99日　商　品　日　報　※

[日計セクション]                                    [月計セクション]
商品名 | 売上数量 | 売上金額 | ... | １粗利益 | １粗利率 | ２粗利益 | ２粗利率 | 売上金額 | １粗利益 | １粗利率 | ２粗利益 | ２粗利率
```

### 1.3 項目定義

#### 日計項目（当日分）
| 番号 | 項目名 | データ元 | フォーマット | 説明 |
|------|--------|----------|--------------|------|
| ① | 売上数量 | 日計売上数量 | `ZZ,ZZ9.99-` | 当日の売上数量 |
| ② | 売上金額 | 日計売上金額＋日計売上返品金額 | `ZZ,ZZZ,ZZ9-` | 当日の売上金額（返品含む） |
| ③ | 仕入値引 | 日計仕入値引金額 | `ZZ,ZZZ,ZZ9-` | 当日の仕入値引額 |
| ④ | 在庫調整 | 日計在庫調整金額 | `ZZ,ZZZ,ZZ9-` | 当日の在庫調整額 |
| ⑤ | 加工費 | 日計加工金額 | `Z,ZZZ,ZZ9-` | 当日の加工費 |
| ⑥ | 振替 | 日計振替金額 | `Z,ZZZ,ZZ9-` | 当日の振替金額 |
| ⑦ | 奨励金 | 日計奨励金 | `Z,ZZZ,ZZ9-` | 当日の奨励金 |
| ⑧ | １粗利益 | 日計粗利益 | `ZZ,ZZZ,ZZ9-` | 第1段階粗利益 |
| ⑨ | １粗利率 | 計算値 | `ZZ9.99-%` | ⑧÷②×100（小数第3位四捨五入） |
| ⑩ | ２粗利益 | 日計粗利益－日計歩引額 | `ZZ,ZZZ,ZZ9-` | 第2段階粗利益（歩引後） |
| ⑪ | ２粗利率 | 計算値 | `ZZ9.99-%` | ⑩÷②×100（小数第3位四捨五入） |

#### 月計項目（当月累計）
| 番号 | 項目名 | データ元 | フォーマット | 説明 |
|------|--------|----------|--------------|------|
| ⑫ | 売上金額 | 日計売上金額＋日計売上返品金額＋月計売上金額＋月計売上返品金額 | `ZZZ,ZZZ,ZZ9-` | 月累計売上金額 |
| ⑬ | １粗利益 | 日計粗利益＋月計粗利益 | `ZZ,ZZZ,ZZ9-` | 月累計第1段階粗利益 |
| ⑭ | １粗利率 | 計算値 | `ZZ9.99-%` | ⑬÷⑫×100（小数第3位四捨五入） |
| ⑮ | ２粗利益 | 日計粗利益＋月計粗利益－日計歩引額－月計歩引額 | `ZZ,ZZZ,ZZ9▲-` | 月累計第2段階粗利益 |
| ⑯ | ２粗利率 | 計算値 | `ZZ9.99-%` | ⑮÷⑫×100（小数第3位四捨五入） |

### 1.4 処理仕様

#### ソート順序
1. 商品分類1（担当者コード）
2. 商品コード

#### 集計ルール
1. CP在庫Mを上記順序でソート
2. 各商品の明細行を出力
   - **オール0の明細は印字しない**
3. 商品分類1が変わったら「＊　大分類計　＊」を印字
   - 明細がない大分類計は印字しない
4. 最終行に「※　合　　計　※」を印字

#### 粗利益計算式
```
第1段階粗利益 = (売上単価 - 在庫単価) × 数量
第2段階粗利益 = 第1段階粗利益 - 歩引額
```

### 1.5 表示フォーマット記号
- `Z`: ゼロサプレス（先頭の0を空白に）
- `9`: 数字表示
- `,`: 3桁区切りカンマ
- `.`: 小数点
- `-`: マイナス記号（負の値の場合のみ）
- `▲`: 負の値を示す三角印
- `%`: パーセント記号

---

## 2. 在庫表

### 2.1 概要
- **目的**: 現在の在庫状況を担当者別・商品別に表示
- **データソース**: CP在庫M
- **出力形式**: A4縦向き

### 2.2 レイアウト構造

```
※　202Y年99月99日　在　庫　表　※

担当者コード: XX

商品名 | 荷印 | 等級 | 階級 | 在庫数量 | 在庫単価 | 在庫金額 | 最終入荷日 | ﾏｰｸ
```

### 2.3 項目定義

| 項目名 | データ元 | フォーマット | 説明 |
|---------|----------|--------------|------|
| 商品名 | 商品マスタ | 文字列 | 商品名称 |
| 荷印 | 荷印マスタ | 文字列 | 荷印名称 |
| 等級 | 等級マスタ | 文字列 | 等級名称 |
| 階級 | 階級マスタ | 文字列 | 階級名称 |
| 在庫数量 | 当日在庫数量 | `ZZ,ZZ9.99-` | 現在の在庫数量 |
| 在庫単価 | 当日在庫単価 | `ZZZ,ZZ9` | 現在の在庫単価 |
| 在庫金額 | 当日在庫金額 | `ZZ,ZZZ,ZZ9-` | 在庫数量×在庫単価 |
| 最終入荷日 | 最終入荷日 | `(YY-MM-DD)` | 最後に入荷した日付 |
| ﾏｰｸ | 計算値 | `!` `!!` `!!!` | 滞留警告マーク |

### 2.4 処理仕様

#### ソート順序
1. 担当者コード（商品分類1）- **改ページ**
2. 商品コード
3. 荷印コード
4. 荷印名（手入力）
5. 等級コード
6. 階級コード

#### 集計ルール
1. **前日在庫数が0の行は印字しない**
2. **当日在庫数量および当日在庫金額が0の明細は印字しない**
3. 担当者コードが変わったら改ページ
4. 商品コードが変わったら「＊　小　　計　＊」を印字
   - 明細がない小計は印字しない
5. 最終行に「※　合　　計　※」を印字

#### 滞留警告マーク仕様
最終入荷日からの経過日数により表示：
- 11日以上20日経過: `!`
- 21日以上30日経過: `!!`
- 31日以上経過: `!!!`

---

## 3. 共通仕様

### 3.1 除外データルール
以下のデータは処理によって扱いが異なる：

#### アンマッチ・商品勘定で除外
- 荷印名の先頭4文字が「EXIT」「exit」
- 荷印コードが「9900」「9910」「1353」

#### 商品日報・在庫表では使用
上記の除外データも含めて処理

### 3.2 特殊処理ルール
荷印名による商品分類1の自動設定：
- 荷印名先頭「9aaa」→ 商品分類1='8'
- 荷印名先頭「1aaa」→ 商品分類1='6'
- 荷印名先頭「0999」→ 商品分類1='6'

### 3.3 CP在庫M作成ルール
1. 各処理（アンマッチ、商品勘定、商品日報等）で**毎回新規に作成**
2. 当日エリアクリア → 当日発生フラグ='9'
3. データ集計 → 当日発生フラグ='0'
4. 在庫計算・粗利計算を実行

### 3.4 データ量の目安
- 売上伝票: 500-1,200件/日
- 仕入伝票: 200-400件/日
- 在庫マスタ: 年間約10,000件

---

## 4. マスタファイル構造

### 4.1 商品分類マスタ（CSV）
| カラム名 | 型 | 説明 |
|----------|-----|------|
| コード | String | 商品分類コード |
| 名称 | String | 商品分類名称 |
| 検索カナ | String | 検索用カナ |

### 4.2 在庫マスタキー構造（5項目複合キー）
```csharp
public class InventoryKey
{
    public string ProductCode { get; set; }      // 商品コード
    public string GradeCode { get; set; }        // 等級コード  
    public string ClassCode { get; set; }        // 階級コード
    public string ShippingMarkCode { get; set; } // 荷印コード
    public string ShippingMarkName { get; set; } // 荷印名
}
```

---

## 5. 実装時の注意事項

### 5.1 パフォーマンス
- バッチ処理は1000件単位で実行
- 大量データは一括読み込みしない
- 帳票生成は可能な限り並列化

### 5.2 エラーハンドリング
- 0除算対策を必ず実装（粗利率計算時）
- データセットID管理による誤操作防止
- 日次終了処理は最終商品日報と同じデータセットのみ処理可能

### 5.3 日付管理
- **汎用日付2（ジョブデート）**を使用
- 伝票日付ではなく、実際の入力日で処理

### 5.4 ファイル構成
```
D:\InventoryImport\
└── User01\（部門別）
    ├── Import\     # CSV取込先
    ├── Processed\  # 処理済み
    └── Error\      # エラー
```


## 🔗 GitHubリポジトリ情報

### リポジトリURL
https://github.com/hiromaya/InventoryManagementSystem

### ブランチ構成
- **main**: メインブランチ（本番用）
- その他のブランチは必要に応じて作成

### コミット規約
- feat: 新機能追加
- fix: バグ修正
- docs: ドキュメント更新
- style: コードスタイル修正
- refactor: リファクタリング
- test: テスト追加・修正
- chore: ビルド設定等の変更

### 自動push設定
プロジェクトルートに以下のスクリプトが用意されています：
- `git-push.sh`: Linux/Mac用
- `git-push.bat`: Windows用

使用例：
```bash
# Linux/Mac
./git-push.sh "コミットメッセージ"

# Windows
git-push.bat "コミットメッセージ"
```

### GitHub認証情報
Personal Access Token（PAT）を使用した認証が設定済み。
`git push`コマンドで自動的にGitHubへプッシュ可能。

## 🔨 新しいルールの追加プロセス

ユーザーから今回限りではなく常に対応が必要だと思われる指示を受けた場合：

1. 「これを標準のルールにしますか？」と質問する
2. YESの回答を得た場合、このCLAUDE.mdに追加ルールとして記載する
3. 以降は標準ルールとして常に適用する

このプロセスにより、プロジェクトのルールを継続的に改善していきます。

---

最終更新日: 2025年6月18日