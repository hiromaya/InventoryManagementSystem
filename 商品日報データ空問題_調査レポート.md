# 商品日報データ空問題 - 調査レポート

## 調査日時
2025-07-05

## 問題の概要
商品日報（2025-06-17）のPDF出力において、以下の問題が発生しています：
- 日計データ（売上数量・金額・粗利益）がすべて0
- 月計データ（売上金額・粗利益）もすべて0  
- 商品コードや商品名が一切表示されない（「※ 合計 ※」の行のみ）

## ログ分析結果

### 1. CP在庫マスタ作成の問題
```
CP在庫マスタ作成完了 - 作成件数: 0
```
**問題点**: 在庫マスタから CP在庫マスタへのデータ作成が0件となっています。

**原因**: 
- 2025-06-17時点の在庫マスタ（InventoryMaster）にデータが存在しない
- JobDate = '2025-06-17' の在庫マスタレコードが0件

### 2. 当日データ集計の問題
```
売上データ集計完了 - 更新件数: 0
仕入データ集計完了 - 更新件数: 0
在庫調整データ集計完了 - 更新件数: 0
```
**問題点**: すべての伝票データの集計が0件となっています。

**可能性のある原因**:
- 2025-06-17の売上・仕入・在庫調整伝票が存在しない
- もしくは、CP在庫マスタが0件のため、更新対象が存在しない

### 3. 有効データの不在
```
CP在庫Mデータ取得完了 - 件数: 0
有効な在庫データ件数: 0
有効なデータが0件です。全CP在庫データからサンプルを表示します。
```
**問題点**: CP在庫マスタ自体が空のため、レポート生成するデータが存在しません。

## 根本原因の分析

### 1. 在庫マスタの状態確認が必要
- `InventoryMaster`テーブルに2025-06-17のデータが存在するか
- 在庫マスタは日次終了処理によって更新されるため、該当日の日次終了が実行されていない可能性

### 2. 伝票データの存在確認が必要
- `SalesVouchers`（売上伝票）
- `PurchaseVouchers`（仕入伝票）
- `InventoryAdjustments`（在庫調整）
上記テーブルに2025-06-17のデータが存在するか確認が必要

### 3. プロセスフローの確認
商品日報生成の前提条件：
1. CSVインポート実行済み（import-folder コマンド）
2. アンマッチリスト作成済み（create-unmatch-list コマンド）
3. 在庫マスタにJobDate='2025-06-17'のデータが存在

## 推定される問題シナリオ

### シナリオ1: CSVインポート未実行
- 2025-06-17のCSVデータがインポートされていない
- import-folderコマンドが実行されていない

### シナリオ2: アンマッチリスト処理未実行
- CSVインポートは実行したが、create-unmatch-listコマンドが実行されていない
- アンマッチリスト処理によって在庫マスタが更新されるため、これが未実行だと在庫マスタにデータが存在しない

### シナリオ3: 日付の不整合
- インポートしたデータのJobDateと、商品日報生成時の指定日付が異なる
- 例：2025-06-27のデータをインポートしたが、2025-06-17の日報を生成しようとしている

## 確認すべき項目

### 1. データベース確認クエリ
```sql
-- 在庫マスタの確認
SELECT COUNT(*) as 在庫マスタ件数, MIN(JobDate) as 最古日付, MAX(JobDate) as 最新日付
FROM InventoryMaster;

-- 2025-06-17の在庫マスタ
SELECT COUNT(*) as 件数 
FROM InventoryMaster 
WHERE JobDate = '2025-06-17';

-- 売上伝票の確認
SELECT COUNT(*) as 売上件数, MIN(JobDate) as 最古日付, MAX(JobDate) as 最新日付
FROM SalesVouchers;

-- 2025-06-17の売上伝票
SELECT COUNT(*) as 件数 
FROM SalesVouchers 
WHERE JobDate = '2025-06-17';

-- 仕入伝票の確認
SELECT COUNT(*) as 仕入件数, MIN(JobDate) as 最古日付, MAX(JobDate) as 最新日付
FROM PurchaseVouchers;

-- CP在庫マスタの確認
SELECT COUNT(*) as CP在庫件数 
FROM CP_InventoryMaster;
```

### 2. 実行履歴の確認
- import-folderコマンドの実行履歴
- create-unmatch-listコマンドの実行履歴
- 各コマンドで処理された日付

## 推奨される対応手順

### 1. データ存在確認
上記のSQLクエリを実行し、各テーブルのデータ状態を確認する

### 2. 正しい処理順序での実行
```bash
# 1. CSVインポート（2025-06-17のデータ）
dotnet run -- import-folder DeptA 2025-06-17

# 2. アンマッチリスト作成（在庫マスタ更新）
dotnet run -- create-unmatch-list 2025-06-17

# 3. 商品日報生成
dotnet run -- create-daily-report 2025-06-17
```

### 3. 月計データの場合
月計データを正しく表示するには、月初からのデータが必要：
```bash
# 月初から順次インポート
dotnet run -- import-folder DeptA 2025-06-01
dotnet run -- import-folder DeptA 2025-06-02
# ... 17日まで継続
dotnet run -- import-folder DeptA 2025-06-17

# アンマッチリスト作成
dotnet run -- create-unmatch-list 2025-06-17

# 商品日報生成
dotnet run -- create-daily-report 2025-06-17
```

## 結論

商品日報にデータが表示されない根本原因は、**CP在庫マスタの作成件数が0件**であることです。これは以下のいずれかが原因と考えられます：

1. **在庫マスタ（InventoryMaster）に2025-06-17のデータが存在しない**
2. **CSVインポートが実行されていない**
3. **アンマッチリスト処理が実行されていない**

まずはデータベースの状態を確認し、必要な前処理（CSVインポート、アンマッチリスト作成）が正しく実行されているか確認することが重要です。