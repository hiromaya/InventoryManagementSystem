# 🚨 アンマッチリスト仕様妥当性に関する重大問題分析

**調査日時**: 2025年7月26日 15:40  
**調査者**: Claude  
**調査種別**: 前回調査結果の問題点精査と仕様妥当性分析  
**緊急度**: 🔴 **高（仕様変更検討必要）**  

## 📋 調査の背景

前回調査（`アンマッチリスト同日相殺処理_実装調査_20250726_detailed.md`）では「同日相殺は正しく実装されている」と結論づけたが、これは**技術的実装の正確性のみ**を評価したものであり、**ビジネス要件の妥当性**を検証していなかった。

ユーザー指摘により、重大な仕様問題が発覚。

---

## 🔍 問題の本質

### 1. 前回調査の致命的欠陥

#### ❌ 前回の誤った結論
「同日相殺は正しく実装されている」→ **技術的にのみ正しい**

#### ✅ 実際の状況
- **技術的実装**: 仕様書通りに正確に動作している
- **ビジネス要件**: 仕様書自体がビジネス要件を満たしていない

### 2. 問題の核心：「明かな伝票入力ミス」の定義

#### 📖 仕様書の文言（推定）
> 「前日在庫≧0 かつ 当日在庫≦0」の場合、在庫0エラーとする

#### 💼 ビジネス要件の本来の意図（推定）
> 「在庫がないのに売上を計上した明かな入力ミス」を検出したい

---

## 📊 具体的問題ケースの分析

### ケース1: 典型的な同日相殺（商品00104・荷印5123）

```
■ 実際のデータ（23.json 行20-25）
初期在庫: 0.0000
売上件数: 1
仕入件数: 1

■ 処理フロー
1. 前日在庫: 0個
2. 仕入処理: +1個 → 在庫1個
3. 売上処理: -1個 → 在庫0個
4. 最終在庫: 0個

■ 現在の判定
PreviousDayStock(0) >= 0 ✓
DailyStock(0) <= 0 ✓
→ 「在庫0エラー」として検出

■ ビジネス観点での評価
これは正常な取引であり、「明かな入力ミス」ではない
```

### ケース2: 初期在庫があるケース（商品00604・荷印5284）

```
■ 実際のデータ（23.json 行675-681）
初期在庫: 0.0000
売上件数: 10
仕入件数: 2

■ 想定される処理フロー
1. 前日在庫: 0個
2. 仕入処理: +X個 → 在庫X個
3. 売上処理: -Y個 → 在庫(X-Y)個
4. 最終在庫: 0個以下

■ 現在の判定
→ 「在庫0エラー」として検出

■ 問題点
売上件数が仕入件数を大幅に上回る場合でも、
同じ「在庫0エラー」として分類される
```

---

## 🎯 仕様問題の詳細分析

### 1. 現在の判定ロジックの問題点

#### A. 判定条件（UnmatchListService.cs:470-476行）
```csharp
else if (cpInventory.PreviousDayStock >= 0 && cpInventory.DailyStock <= 0)
{
    // 在庫0以下エラー（マイナス在庫含む）
    var unmatchItem = UnmatchItem.FromSalesVoucher(sales, "在庫0",
        cpInventory.GetAdjustedProductCategory1());
    unmatchItems.Add(unmatchItem);
}
```

#### B. 問題の構造
1. **過度に広範囲な検出**: 正常な取引も「エラー」扱い
2. **誤解を招く命名**: 「在庫0エラー」だが実際は「結果的に在庫0」
3. **ビジネス価値の欠如**: 真の問題を見つけられない

### 2. ビジネス要件とのギャップ分析

#### 検出したい真の問題
```
■ パターンA: 在庫不足での売上計上
前日在庫: 5個
売上: 10個
仕入: 0個
→ 明らかな入力ミス

■ パターンB: データ不整合
前日在庫: 0個
売上: 10個
仕入: 0個
→ 在庫がないのに売上計上
```

#### 現在誤検出している正常パターン
```
■ パターンC: 同日相殺
前日在庫: 0個
売上: 10個
仕入: 10個
→ 正常な取引だが「エラー」扱い

■ パターンD: 完全相殺
前日在庫: 5個
売上: 10個
仕入: 5個
→ 正常な取引だが「エラー」扱い
```

---

## 💡 根本原因の特定

### 1. 仕様設計時の認識不足

#### 想定された状況
- 「在庫0になる = 問題」という単純な発想
- 同日相殺という正常業務フローへの配慮不足

#### 実際のビジネス環境
- 同日の売上・仕入相殺は**日常的な正常業務**
- 「結果的に在庫0」と「売り越し」は**全く異なる問題**

### 2. 判定タイミングの問題

#### 現在の判定タイミング
```
全ての取引処理完了後 → 最終結果で判定
```

#### あるべき判定タイミング
```
各売上取引時点 → その瞬間の在庫状況で判定
```

---

## 📈 影響度分析

### 1. 定量的影響

#### 調査データ（23.json）からの推定
```
総レコード数: 826件
同日相殺の可能性があるケース:
- 商品00104・荷印5123: 売上1・仕入1 → 完全相殺
- 商品00604・荷印5284: 売上10・仕入2 → 部分相殺
- その他多数の「初期在庫0・売上あり・仕入あり」ケース

推定誤検出率: 20-30%（正常取引をエラー扱い）
```

### 2. 定性的影響

#### オペレーション業務への影響
- ✅ 正常な取引を「エラー」として報告
- ❌ 真の問題が「正常」に埋もれる可能性
- 🔄 無駄な確認作業の発生
- 📉 システムへの信頼度低下

---

## 🔧 解決策の提案

### 1. 即座に可能な対応（軽微修正）

#### A. 判定条件の調整
```csharp
// 現在（問題あり）
if (cpInventory.PreviousDayStock >= 0 && cpInventory.DailyStock <= 0)

// 提案1（マイナス在庫のみ）
if (cpInventory.PreviousDayStock >= 0 && cpInventory.DailyStock < 0)

// 提案2（完全無在庫のみ）
if (cpInventory.PreviousDayStock == 0 && cpInventory.DailyStock < 0 && cpInventory.DailyPurchaseQuantity == 0)
```

### 2. 根本的解決策（要検討）

#### A. 時系列在庫チェック
```
各売上伝票処理時に、その時点での利用可能在庫をチェック
- 前日在庫 + それまでの仕入 - それまでの売上 < 現在の売上数量
```

#### B. カテゴリ別アラート
```
- 「マイナス在庫アラート」: DailyStock < 0
- 「売り越しアラート」: 在庫不足での売上計上
- 「要確認」: 同日相殺で結果的に在庫0
```

---

## 📋 推奨対応手順

### Phase 1: 緊急対応
1. **クライアント確認**
   - 現在の仕様の意図確認
   - 同日相殺の扱いについて確認
   - 「明かな入力ミス」の定義確認

### Phase 2: 暫定対応
1. **判定条件調整**
   - DailyStock < 0（マイナス在庫）のみをエラー扱い
   - または、DailyPurchaseQuantity == 0の条件追加

### Phase 3: 本格対応
1. **時系列チェック実装**
   - 売上時点での在庫不足検出
   - より精密な問題特定機能

---

## ⚠️ 重要な注意事項

### 1. コード修正前の必須確認事項
- [ ] クライアントへの仕様意図確認
- [ ] 現在誤検出されているケースの業務的妥当性確認
- [ ] 修正による影響範囲の評価

### 2. テスト時の確認ポイント
- [ ] 真の問題が正しく検出されるか
- [ ] 正常な同日相殺が誤検出されないか
- [ ] マイナス在庫が確実に検出されるか

---

## 🎯 結論

### 前回調査結果の訂正
**「同日相殺は正しく実装されている」→ 「技術的には正しいが、ビジネス要件を満たしていない」**

### 真の問題
現在の仕様は正常な業務取引を「エラー」として誤検出しており、システムの実用性を大幅に損なっている。

### 緊急度
🔴 **高**: クライアントとの仕様確認と修正が必要

---

**調査担当者**: Claude  
**次回対応**: クライアント仕様確認後の修正実装  
**参考資料**: クエリ２フォルダのJSONファイル群、UnmatchListService.cs  