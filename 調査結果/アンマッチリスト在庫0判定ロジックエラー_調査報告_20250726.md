# アンマッチリスト在庫0判定ロジックエラー調査報告

**調査日時**: 2025年7月26日  
**調査対象**: 在庫0アラートの判定ロジック  
**問題**: 同日売上・仕入相殺による誤った在庫0アラート発生  

## 🚨 重大なロジックエラーの発見

### 現在の誤った実装（UnmatchListService.cs:470行目）

```csharp
else if (cpInventory.PreviousDayStock >= 0 && cpInventory.DailyStock <= 0)
{
    stockZeroCount++;
    // 在庫0以下エラー（マイナス在庫含む）
    var unmatchItem = UnmatchItem.FromSalesVoucher(sales, "在庫0",
        cpInventory.GetAdjustedProductCategory1());
    unmatchItems.Add(unmatchItem);
}
```

### 問題の詳細分析

#### ❌ 現在の誤った判定条件
- **条件**: `PreviousDayStock >= 0 && DailyStock <= 0`
- **問題**: 同日の正常な売上・仕入取引による相殺をエラーとして扱っている

#### 🔍 具体的な問題ケース（商品01703の例）

**データ状況**:
```
前日在庫: 22.0000
当日仕入: +121.0000  (11:仕入伝票 4.0000 + 7.0000 = 11.0000)
当日売上: -121.0000  (51:売上伝票 8件 = 11.0000)
結果: DailyStock = 22.0000 + 11.0000 - 11.0000 = 22.0000
```

**しかし実際のCSVデータでは**:
- 荷印前日在庫数: 22
- 当日在庫数: 24, 23, 25, 18, 15 (売上発生後の残在庫)
- 最終判定: OK (正常)

#### 📊 データ証拠

**クエリ２/２.csv分析結果**:
```csv
"伝票種類","商品コード","等級コード","階級コード","荷印コード","荷印名","数量","金額","5項目キー","除外判定","在庫マスタ存在","荷印前日在庫数","当日在庫数","アンマッチ種別","最終判定","5月末在庫数量","在庫ちぇっく"

売上伝票(51): 8件 - 前日在庫22から順次減少: 24→23→25→23→23→23→23
仕入伝票(11): 2件 - 仕入により在庫増加: 18→15
```

**重要な発見**: すべての取引で`最終判定: OK`となっており、在庫0アラートは発生していない

### 🎯 正しい在庫0アラートの定義

#### ✅ 本来チェックすべき条件

1. **在庫不足による売上不可能**:
   ```csharp
   // 売上時点で在庫が不足している場合
   if (売上前の在庫数量 < 売上数量)
   {
       // 在庫0アラート
   }
   ```

2. **マイナス在庫の検出**:
   ```csharp
   // 取引後に在庫がマイナスになる場合
   if (取引後在庫 < 0)
   {
       // 在庫0アラート（マイナス在庫）
   }
   ```

#### ❌ 現在の誤った判定が生成する問題

**シナリオ**: 前日在庫20、当日仕入10、当日売上30
- 前日在庫: 20 (>= 0) ✓
- 当日在庫: 20 + 10 - 30 = 0 (<= 0) ✓
- **現在のロジック**: "在庫0"アラート発生 ❌ **間違い**
- **正しい判定**: 在庫は十分あったが結果的に0になっただけ ✅ **正常**

### 📈 処理順序の問題

#### 現在の処理フロー（問題あり）
```
1. CP在庫マスタ作成（前日在庫のコピー）
2. 当日売上・仕入・調整データの集計
3. DailyStock計算（CalculateDailyStockAsync）
4. アンマッチ判定（DailyStock <= 0をチェック）← ここが間違い
```

#### 正しい処理フロー（あるべき姿）
```
1. CP在庫マスタ作成（前日在庫のコピー）
2. 各取引を時系列順に処理
3. 各取引時点での在庫充足性をチェック
4. マイナス在庫になる取引をアラート対象とする
```

### 🔍 根本原因の特定

#### 問題1: 時系列を無視した集計ベース判定
- **現状**: 1日分の取引を集計してから判定
- **問題**: 取引発生時点での在庫状況を無視
- **結果**: 正常な取引でも結果的にDailyStock=0になると誤ってアラート

#### 問題2: 在庫0の定義の誤解
- **現状**: 最終的にDailyStock <= 0になることを問題視
- **正しい定義**: 取引時点で在庫が不足していることが問題

#### 問題3: 売上・仕入の処理順序を考慮しない設計
- **問題**: 売上→仕入、仕入→売上どちらの順序でも同じ判定
- **現実**: 売上は在庫がある時点で実行、仕入は在庫を増やす

### 📋 修正が必要な箇所

#### 1. UnmatchListService.cs (470行目)
```csharp
// ❌ 現在の誤った実装
else if (cpInventory.PreviousDayStock >= 0 && cpInventory.DailyStock <= 0)

// ✅ 修正案（詳細設計は別途必要）
// 各売上取引時点での在庫充足性をチェックする新しいロジックに置き換え
```

#### 2. 同様の問題がある箇所
- **CheckPurchaseUnmatchAsync** (541行目): `cpInventory.DailyStock <= 0`
- **CheckInventoryAdjustmentUnmatchAsync** (663行目): `cpInventory.DailyStock <= 0`

### 🎯 推奨される修正方針

#### フェーズ1: 時系列ベース在庫チェック
1. 取引を時刻順にソート
2. 各取引時点での在庫残高を計算
3. 在庫不足で実行される取引をアラート対象とする

#### フェーズ2: 在庫0アラートの再定義
1. 「在庫がない状態での売上」のみをアラート
2. 「結果的に在庫が0になる」ことは正常として扱う
3. マイナス在庫は別途「マイナス在庫アラート」として分類

### 📊 影響範囲

#### 修正により解決される問題
1. ✅ 同日売上・仕入相殺による誤アラートの除去
2. ✅ 正常な取引に対するノイズアラートの削減
3. ✅ 真の在庫不足問題の正確な検出

#### 注意が必要な点
1. ⚠️ 既存の「在庫0」アラートに依存した運用の見直しが必要
2. ⚠️ 時系列処理によるパフォーマンス影響の検証が必要
3. ⚠️ 過去のアンマッチリスト結果との整合性確認が必要

### 🏁 結論

**現在の在庫0判定ロジックは根本的に間違っており、正常な業務取引を誤ってアラート対象としている。**

- 同日に発生した売上と仕入が相殺してDailyStock=0になることは正常な業務フロー
- 真の問題は「在庫がない時点での売上発生」であり、「結果的な在庫0」ではない
- 修正には取引の時系列処理が必要で、設計レベルでの変更が必要

**緊急度: 高** - 現在のシステムは誤ったアラートを大量生成している可能性が高い

---

**調査者**: Claude Code  
**調査完了日時**: 2025年7月26日  
**次のアクション**: ロジック修正の詳細設計および実装方針の策定