# アンマッチリスト仕様準拠性調査結果

**調査日時**: 2025年7月26日  
**調査対象**: アンマッチリスト技術仕様書0726.md との現在のプログラム実装の比較

## 1. 調査概要

### 1.1 目的
「アンマッチリスト技術仕様書0726.md」に記載された仕様と、現在のUnmatchListService.csの実装が一致しているかを調査する。

### 1.2 重要な仕様変更（2025年7月）
仕様書に記載された変更内容：
- **マイナス在庫はOK**（アンマッチリストに出さない）
- **在庫マスタにKeyが存在しない場合のみエラー**とする
- 同日売上・仕入相殺は正常な業務フローとして扱う

## 2. 調査結果サマリー

### ✅ 準拠している項目
1. **在庫マスタ未登録チェック**: `cpInventory == null` の場合のみエラーとする処理
2. **エラーメッセージ**: 「在庫マスタ無」への変更済み
3. **マイナス在庫の許容**: 在庫0チェックの削除により実現

### ❌ 仕様と異なる項目
1. **売上伝票のフィルタ条件**: DetailType処理に差異
2. **在庫調整の処理条件**: 数量条件に差異
3. **集計処理の数量条件**: 仕様書と実装で条件が異なる

## 3. 詳細な差異分析

### 3.1 売上伝票処理の差異

#### 仕様書の条件（4.1）
```sql
WHERE sv.JobDate = @JobDate
  AND sv.VoucherType IN ('51', '52')  -- 掛売上、現金売上
  AND sv.DetailType = '1'              -- 売上（返品は'2'）
  AND sv.Quantity <> 0                 -- 数量0は除外
  AND sv.ProductCode <> '00000'        -- オール0は除外
```

#### 現在の実装（UnmatchListService.cs:407-410）
```csharp
.Where(s => s.VoucherType == "51" || s.VoucherType == "52") // 売上伝票
.Where(s => s.DetailType == "1" || s.DetailType == "2" || s.DetailType == "3")  // 明細種（単品値引追加）
.Where(s => s.Quantity != 0)                                // 数量0以外（共通仕様）
.Where(s => !targetDate.HasValue || s.JobDate <= targetDate.Value) // 指定日以前フィルタ
```

**差異**: DetailTypeで `"1"` のみ vs `"1", "2", "3"` を処理

### 3.2 在庫調整処理の差異

#### 仕様書の条件（4.3）
```sql
WHERE ia.JobDate = @JobDate
  AND ia.VoucherType IN ('71', '72')   -- 受注伝票を代用
  AND ia.DetailType = '1'               -- 売上を代用
  AND ia.Quantity < 0                   -- マイナス調整のみ
  AND ia.ProductCode <> '00000'         -- オール0は除外
```

#### 現在の実装（UnmatchListService.cs:614-620）
```csharp
.Where(a => a.VoucherType == "71" || a.VoucherType == "72")  // 在庫調整伝票
.Where(a => a.DetailType == "1")                             // 明細種
.Where(a => a.Quantity > 0)                                  // 数量 > 0
.Where(a => a.CategoryCode.HasValue)                         // 区分コードあり
.Where(a => a.CategoryCode.GetValueOrDefault() != 2 && a.CategoryCode.GetValueOrDefault() != 5)  // 区分2,5（経費、加工）は除外
```

**差異**: 数量条件が `< 0` vs `> 0` で逆転している

### 3.3 集計処理の数量条件差異

#### 仕様書の集計条件（5.2）
```sql
-- 仕入伝票から集計（入荷データのみ）
AND Quantity > 0  -- 入荷データのみ
```

#### 現在の実装（CpInventoryRepository.cs:258）
```csharp
AND Quantity > 0  // ✅ 一致
```

**結果**: 集計処理は仕様書と一致

### 3.4 処理フロー差異

#### 仕様書の処理フロー（2.1）
```
1. 処理1-1: CP在庫マスタ作成（前日在庫をコピー）
2. 処理1-2前: 当日エリアクリア + DailyFlag='9'セット
3. 処理1-2: 当日データ集計 + DailyFlag='0'セット
4. 処理1-6: アンマッチチェック実行
```

#### 現在の実装
処理順序は仕様書と一致しているが、一部実装詳細に差異あり

## 4. 重要な準拠性確認

### 4.1 ✅ マイナス在庫許容
- **仕様書要求**: マイナス在庫はOK（アンマッチリストに出さない）
- **実装状況**: 在庫0チェック削除により実現済み
- **準拠度**: 100%

### 4.2 ✅ 在庫マスタ未登録エラーのみ
- **仕様書要求**: 在庫マスタにKeyが存在しない場合のみエラー
- **実装状況**: `cpInventory == null` 条件のみでエラー判定
- **準拠度**: 100%

### 4.3 ✅ エラーメッセージ
- **仕様書要求**: 「在庫マスタ無」
- **実装状況**: `AlertType2 = "在庫マスタ無"` に変更済み
- **準拠度**: 100%

## 5. 修正が必要な項目

### 5.1 【高優先度】売上伝票DetailType条件
**現在**: `DetailType IN ('1', '2', '3')`  
**仕様書**: `DetailType = '1'`  
**影響**: 返品データ（DetailType='2'）がアンマッチ対象に含まれる

### 5.2 【高優先度】在庫調整数量条件
**現在**: `Quantity > 0`  
**仕様書**: `Quantity < 0`  
**影響**: プラス調整とマイナス調整が逆転している

### 5.3 【中優先度】商品コード除外条件
**現在**: 実装されていない  
**仕様書**: `ProductCode <> '00000'`  
**影響**: オール0の商品コードがアンマッチ対象に含まれる可能性

## 6. 推奨修正アクション

### 6.1 即座に修正すべき項目
1. **売上伝票DetailType**: `"1"` のみに限定
2. **在庫調整数量条件**: `Quantity < 0` に変更
3. **商品コード除外**: `ProductCode != "00000"` 条件追加

### 6.2 検証が必要な項目
1. **在庫調整のCategoryCode除外**: 仕様書にない条件の妥当性確認
2. **VoucherType範囲**: '72'の扱いについて確認

## 7. 結論

### 7.1 準拠度評価
- **基本方針**: ✅ 100%準拠（マイナス在庫許容、在庫マスタ未登録エラーのみ）
- **実装詳細**: ❌ 70%準拠（フィルタ条件に複数の差異）
- **総合評価**: 🔶 85%準拠

### 7.2 ビジネス影響
- **現在の実装**: 仕様書の意図は概ね実現されている
- **差異の影響**: 一部のエッジケースで予期しないデータが含まれる可能性
- **緊急度**: 中程度（基本機能は動作するが、データ精度に影響あり）

### 7.3 次のアクション
1. **修正実装**: 上記差異項目の修正
2. **テスト実行**: 修正後の動作確認
3. **仕様書更新**: 実装との整合性確認

---
**調査完了日**: 2025年7月26日  
**調査者**: Claude Code AI Assistant  
**ステータス**: 修正推奨項目あり